<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ’ç­ç³»çµ±</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .auth-section {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .calendar-section {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .calendar {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 2px;
        margin-top: 20px;
      }

      .calendar-header {
        background: #4caf50;
        color: white;
        padding: 10px;
        text-align: center;
        font-weight: bold;
      }

      .week-button-header {
        background: #ff9800;
        color: white;
        padding: 10px;
        text-align: center;
        font-weight: bold;
        font-size: 12px;
      }

      .week-button {
        background: #fff3e0;
        border: 1px solid #ff9800;
        min-height: 80px;
        padding: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .week-button:hover {
        background: #ffe0b2;
      }

      .week-button button {
        background: #ff9800;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 11px;
        white-space: nowrap;
      }

      .week-button button:hover {
        background: #f57c00;
      }

      .calendar-day {
        background: #f9f9f9;
        border: 1px solid #ddd;
        min-height: 80px;
        padding: 5px;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .calendar-day:hover {
        background: #e8f5e8;
      }

      .calendar-day.occupied {
        background: #ffcdd2;
      }

      .calendar-day.my-shift {
        background: #c8e6c9;
      }

      .day-number {
        font-weight: bold;
        margin-bottom: 5px;
      }

      .shift-info {
        font-size: 12px;
        color: #666;
      }

      .controls {
        margin-bottom: 20px;
        text-align: center;
      }

      .controls button {
        margin: 5px;
        padding: 10px 15px;
        background: #4caf50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      .controls button:hover {
        background: #45a049;
      }

      .month-navigation {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .month-navigation button {
        padding: 10px 15px;
        background: #2196f3;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      .month-navigation button:hover {
        background: #1976d2;
      }

      .current-month {
        font-size: 18px;
        font-weight: bold;
      }

      .hidden {
        display: none;
      }

      .error {
        color: red;
        margin-top: 10px;
      }

      .success {
        color: green;
        margin-top: 10px;
      }

      input[type="email"],
      input[type="password"] {
        width: 200px;
        padding: 8px;
        margin: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      button {
        padding: 8px 15px;
        margin: 5px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      .primary-button {
        background: #4caf50;
        color: white;
      }

      .primary-button:hover {
        background: #45a049;
      }

      .secondary-button {
        background: #f44336;
        color: white;
      }

      .secondary-button:hover {
        background: #d32f2f;
      }

      /* ç•™è¨€æ¿æ¨£å¼ */
      .message-section {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-top: 20px;
      }

      .message-board-title {
        font-size: 18px;
        font-weight: bold;
        color: #333;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e9ecef;
      }

      .message-input-area {
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e9ecef;
      }

      .message-input {
        width: 100%;
        min-height: 80px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        resize: vertical;
        font-family: Arial, sans-serif;
        font-size: 14px;
        box-sizing: border-box;
      }

      .message-input:focus {
        outline: none;
        border-color: #4caf50;
        box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);
      }

      .message-input-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
      }

      .char-count {
        font-size: 12px;
        color: #6c757d;
      }

      .char-count.warning {
        color: #ff9800;
      }

      .char-count.danger {
        color: #f44336;
      }

      .message-submit {
        background: #28a745;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }

      .message-submit:hover {
        background: #218838;
      }

      .message-submit:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }

      .message-list {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        background: white;
      }

      .message-item {
        padding: 15px;
        border-bottom: 1px solid #e9ecef;
        transition: background-color 0.2s;
      }

      .message-item:hover {
        background-color: #f8f9fa;
      }

      .message-item:last-child {
        border-bottom: none;
      }

      .message-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .message-author {
        font-weight: bold;
        color: #495057;
      }

      .message-time {
        font-size: 12px;
        color: #6c757d;
      }

      .message-content {
        color: #343a40;
        line-height: 1.5;
        white-space: pre-wrap;
      }

      .message-actions {
        display: flex;
        gap: 5px;
        margin-left: 10px;
      }

      .message-edit-btn, .message-delete-btn {
        background: transparent;
        border: 1px solid #ddd;
        padding: 4px 8px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s;
      }

      .message-edit-btn {
        color: #007bff;
        border-color: #007bff;
      }

      .message-edit-btn:hover {
        background: #007bff;
        color: white;
      }

      .message-delete-btn {
        color: #dc3545;
        border-color: #dc3545;
      }

      .message-delete-btn:hover {
        background: #dc3545;
        color: white;
      }

      .no-messages {
        text-align: center;
        padding: 40px;
        color: #6c757d;
        font-style: italic;
      }

      .loading-messages {
        text-align: center;
        padding: 20px;
        color: #6c757d;
      }

      /* ç·¨è¼¯ç•™è¨€æ¨¡æ…‹æ¡† */
      .edit-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none; /* æ”¹ç‚º noneï¼Œè€Œä¸æ˜¯ç”¨ hidden class */
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      .edit-modal.show {
        display: flex; /* é¡¯ç¤ºæ™‚ä½¿ç”¨ flex */
      }

      .edit-modal-content {
        background: white;
        padding: 20px;
        border-radius: 8px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .edit-modal-header {
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 15px;
        color: #333;
      }

      .edit-modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 15px;
      }

      .edit-modal-cancel {
        background: #6c757d;
        color: white;
      }

      .edit-modal-save {
        background: #28a745;
        color: white;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>ğŸ—“ï¸ æ’ç­ç³»çµ±</h1>
      <p>é»æ“Šæ—¥æœŸä¾†æ–°å¢æˆ–åˆªé™¤æ‚¨çš„ç­æ¬¡</p>
    </div>

    <!-- ç™»å…¥/è¨»å†Šå€åŸŸ -->
    <div id="auth-section" class="auth-section">
      <h3>è«‹å…ˆç™»å…¥æˆ–è¨»å†Š</h3>
      <div>
        <input type="email" id="email" placeholder="é›»å­éƒµä»¶" />
        <input type="password" id="password" placeholder="å¯†ç¢¼" />
      </div>
      <div>
        <button class="primary-button" onclick="signIn()">ç™»å…¥</button>
        <button class="primary-button" onclick="signUp()">è¨»å†Š</button>
      </div>
      <div id="auth-message"></div>
    </div>

    <!-- ä¸»è¦åŠŸèƒ½å€åŸŸ -->
    <div id="main-section" class="calendar-section hidden">
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 20px;
        "
      >
        <div>
          <span>æ­¡è¿ï¼Œ</span><span id="user-email"></span>
          <span id="role-display" style="margin-left: 10px"></span>
          <button class="secondary-button" onclick="signOut()">ç™»å‡º</button>
        </div>
      </div>

      <div class="controls">
        <button onclick="clearMyMonthlyShifts()">æ¸…é™¤æˆ‘é€™å€‹æœˆçš„æ‰€æœ‰ç­æ¬¡</button>
      </div>

      <div class="month-navigation">
        <button onclick="previousMonth()">Â« ä¸Šå€‹æœˆ</button>
        <div class="current-month" id="current-month"></div>
        <button onclick="nextMonth()">ä¸‹å€‹æœˆ Â»</button>
      </div>

      <div class="calendar" id="calendar">
        <!-- æ—¥æ›†æ¨™é¡Œ -->
        <div class="week-button-header">æ’ç­</div>
        <div class="calendar-header">ä¸€</div>
        <div class="calendar-header">äºŒ</div>
        <div class="calendar-header">ä¸‰</div>
        <div class="calendar-header">å››</div>
        <div class="calendar-header">äº”</div>
        <div class="calendar-header">å…­</div>
        <div class="calendar-header">æ—¥</div>
      </div>
    </div>

    <!-- ç•™è¨€æ¿å€åŸŸ -->
    <div id="message-section" class="message-section hidden">
      <div class="message-board-title" id="message-board-title">
        ğŸ’¬ ç•™è¨€æ¿
      </div>
      
      <!-- åªæœ‰ç™»å…¥å¾Œæ‰é¡¯ç¤ºè¼¸å…¥å€åŸŸ -->
      <div id="message-input-section" class="message-input-area hidden">
        <textarea 
          id="message-input" 
          class="message-input" 
          placeholder="è¼¸å…¥æ‚¨çš„ç•™è¨€...ï¼ˆä¾‹å¦‚ï¼šæ˜å¤©æœ‰äº‹ï¼Œæƒ³æ›ç­çš„åŒäº‹è«‹ç§è¨Šæˆ‘ï¼‰"
          maxlength="500"
        ></textarea>
        <div class="message-input-footer">
          <span id="char-count" class="char-count">0/500</span>
          <button id="message-submit" class="message-submit" onclick="submitMessage()">
            ç™¼è¡¨ç•™è¨€
          </button>
        </div>
      </div>
      
      <div class="message-list" id="message-list">
        <div class="no-messages">è«‹å…ˆç™»å…¥ä»¥æŸ¥çœ‹ç•™è¨€</div>
      </div>
    </div>

    <!-- ç·¨è¼¯ç•™è¨€æ¨¡æ…‹æ¡† - ç¢ºä¿åˆå§‹ç‹€æ…‹æ˜¯éš±è—çš„ -->
    <div id="edit-modal" class="edit-modal">
      <div class="edit-modal-content">
        <div class="edit-modal-header">ç·¨è¼¯ç•™è¨€</div>
        <textarea 
          id="edit-message-input" 
          class="message-input" 
          maxlength="500"
        ></textarea>
        <div class="message-input-footer">
          <span id="edit-char-count" class="char-count">0/500</span>
        </div>
        <div class="edit-modal-footer">
          <button class="edit-modal-cancel" onclick="cancelEdit()">å–æ¶ˆ</button>
          <button class="edit-modal-save" onclick="saveEdit()">å„²å­˜</button>
        </div>
      </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
      // TODO: è«‹å°‡ä¸‹é¢çš„ firebaseConfig æ›¿æ›æˆæ‚¨å¾ Firebase æ§åˆ¶å°å–å¾—çš„é…ç½®
      const firebaseConfig = {
            apiKey: "AIzaSyDcX1hjA9_qyb6kYgYbQaRblwFrXdW-hWo",
            authDomain: "mchplainfilmschedule.firebaseapp.com",
            projectId: "mchplainfilmschedule",
            storageBucket: "mchplainfilmschedule.firebasestorage.app",
            messagingSenderId: "104675634969",
            appId: "1:104675634969:web:3816e35be9d4a551415f88",
            measurementId: "G-5T31DSRENK"
        };

      // å°å…¥ Firebase åŠŸèƒ½
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getAuth,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut as firebaseSignOut,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        addDoc,
        query,
        where,
        getDocs,
        deleteDoc,
        doc,
        orderBy,
        updateDoc,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      // åˆå§‹åŒ– Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // å…¨åŸŸè®Šæ•¸
      let currentDate = new Date();
      let currentUser = null;
      let shiftsData = [];
      let messagesData = [];
      let userRole = "normal";
      let editingMessageId = null;

      // æ¬Šé™è¨­å®š
      const ADMIN_EMAILS = [
        "hw98188@gmail.com",
        // åœ¨é€™è£¡åŠ å…¥ç®¡ç†å“¡ email
      ];

      const READONLY_EMAILS = [
        "readonly@company.com",
        "guest@company.com",
        // åœ¨é€™è£¡åŠ å…¥åªè®€æ¬Šé™çš„ email
      ];

      // æª¢æŸ¥ä½¿ç”¨è€…æ¬Šé™
      function getUserRole(email) {
        if (ADMIN_EMAILS.includes(email)) {
          return "admin";
        } else if (READONLY_EMAILS.includes(email)) {
          return "readonly";
        } else {
          return "normal";
        }
      }

      // ç›£è½èªè­‰ç‹€æ…‹è®ŠåŒ–
      onAuthStateChanged(auth, (user) => {
        if (user) {
          currentUser = user;
          userRole = getUserRole(user.email);

          // é¡¯ç¤ºä¸»è¦å€åŸŸ
          document.getElementById("auth-section").classList.add("hidden");
          document.getElementById("main-section").classList.remove("hidden");
          document.getElementById("message-section").classList.remove("hidden");
          
          // é¡¯ç¤ºç•™è¨€è¼¸å…¥å€åŸŸ
          const messageInputSection = document.getElementById("message-input-section");
          if (messageInputSection) {
            messageInputSection.classList.remove("hidden");
          }

          updateUserInterface();
          loadShifts();
          loadMessages();
        } else {
          currentUser = null;
          userRole = "normal";
          
          // éš±è—ä¸»è¦å€åŸŸ
          document.getElementById("auth-section").classList.remove("hidden");
          document.getElementById("main-section").classList.add("hidden");
          document.getElementById("message-section").classList.add("hidden");
          
          // éš±è—ç•™è¨€è¼¸å…¥å€åŸŸ
          const messageInputSection = document.getElementById("message-input-section");
          if (messageInputSection) {
            messageInputSection.classList.add("hidden");
          }
          
          // æ¸…ç©ºç•™è¨€è³‡æ–™å’Œé¡¯ç¤º
          messagesData = [];
          const messageList = document.getElementById("message-list");
          if (messageList) {
            messageList.innerHTML = '<div class="no-messages">è«‹å…ˆç™»å…¥ä»¥æŸ¥çœ‹ç•™è¨€</div>';
          }
        }
      });

      // æ›´æ–°ä½¿ç”¨è€…ä»‹é¢
      function updateUserInterface() {
        const userEmail = document.getElementById("user-email");
        const roleDisplay = document.getElementById("role-display");

        let roleText = "";
        let roleColor = "";

        switch (userRole) {
          case "admin":
            roleText = "ğŸ‘‘ ç®¡ç†å“¡";
            roleColor = "#ff6b6b";
            break;
          case "readonly":
            roleText = "ğŸ‘ï¸ åªè®€æ¬Šé™";
            roleColor = "#74b9ff";
            break;
          default:
            roleText = "ğŸ‘¤ ä¸€èˆ¬ä½¿ç”¨è€…";
            roleColor = "#00b894";
        }

        userEmail.textContent = currentUser.email;
        roleDisplay.textContent = roleText;
        roleDisplay.style.color = roleColor;
        roleDisplay.style.fontWeight = "bold";

        updateControlsVisibility();
        updateMessageBoardTitle();
      }

      // æ ¹æ“šæ¬Šé™æ›´æ–°æ§åˆ¶æŒ‰éˆ•
      function updateControlsVisibility() {
        const controls = document.querySelector(".controls");

        if (userRole === "readonly") {
          controls.style.display = "none";
        } else {
          controls.style.display = "block";

          if (userRole === "admin") {
            addAdminControls();
          }
        }
      }

      // æ–°å¢ç®¡ç†å“¡å°ˆç”¨æ§åˆ¶æŒ‰éˆ•
      function addAdminControls() {
        const controls = document.querySelector(".controls");

        if (!document.getElementById("admin-controls")) {
          const adminDiv = document.createElement("div");
          adminDiv.id = "admin-controls";
          adminDiv.style.marginTop = "10px";
          adminDiv.style.padding = "10px";
          adminDiv.style.backgroundColor = "#fff5f5";
          adminDiv.style.border = "2px solid #ff6b6b";
          adminDiv.style.borderRadius = "5px";

          adminDiv.innerHTML = `
            <div style="color: #ff6b6b; font-weight: bold; margin-bottom: 10px;">ğŸ‘‘ ç®¡ç†å“¡åŠŸèƒ½</div>
            <button onclick="clearAllMonthlyShifts()" style="background: #ff6b6b; margin: 5px;">æ¸…é™¤æ‰€æœ‰äººé€™å€‹æœˆçš„ç­æ¬¡</button>
            <button onclick="showMonthlyStats()" style="background: #0984e3; margin: 5px;">æŸ¥çœ‹æœˆåº¦çµ±è¨ˆ</button>
          `;

          controls.appendChild(adminDiv);
        }
      }

      // è¨»å†ŠåŠŸèƒ½
      window.signUp = async function () {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const messageDiv = document.getElementById("auth-message");

        try {
          await createUserWithEmailAndPassword(auth, email, password);
          messageDiv.innerHTML = '<div class="success">è¨»å†ŠæˆåŠŸï¼</div>';
        } catch (error) {
          messageDiv.innerHTML =
            '<div class="error">è¨»å†Šå¤±æ•—ï¼š' + error.message + "</div>";
        }
      };

      // ç™»å…¥åŠŸèƒ½
      window.signIn = async function () {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const messageDiv = document.getElementById("auth-message");

        try {
          await signInWithEmailAndPassword(auth, email, password);
          messageDiv.innerHTML = '<div class="success">ç™»å…¥æˆåŠŸï¼</div>';
        } catch (error) {
          messageDiv.innerHTML =
            '<div class="error">ç™»å…¥å¤±æ•—ï¼š' + error.message + "</div>";
        }
      };

      // ç™»å‡ºåŠŸèƒ½
      window.signOut = async function () {
        try {
          await firebaseSignOut(auth);
        } catch (error) {
          console.error("ç™»å‡ºå¤±æ•—ï¼š", error);
        }
      };

      // è¼‰å…¥ç­è¡¨æ•¸æ“š
      async function loadShifts() {
        try {
          const shiftsRef = collection(db, "shifts");
          const q = query(shiftsRef, orderBy("date"));
          const querySnapshot = await getDocs(q);

          shiftsData = [];
          querySnapshot.forEach((doc) => {
            shiftsData.push({ id: doc.id, ...doc.data() });
          });

          renderCalendar();
        } catch (error) {
          console.error("è¼‰å…¥ç­è¡¨å¤±æ•—ï¼š", error);
        }
      }

      // æ–°å¢ç­æ¬¡
      async function addShift(dateStr) {
        try {
          await addDoc(collection(db, "shifts"), {
            date: dateStr,
            userId: currentUser.uid,
            userEmail: currentUser.email,
            timestamp: new Date(),
          });
          loadShifts();
        } catch (error) {
          console.error("æ–°å¢ç­æ¬¡å¤±æ•—ï¼š", error);
          alert("æ–°å¢ç­æ¬¡å¤±æ•—ï¼š" + error.message);
        }
      }

      // åˆªé™¤ç­æ¬¡
      async function removeShift(shiftId) {
        try {
          await deleteDoc(doc(db, "shifts", shiftId));
          loadShifts();
        } catch (error) {
          console.error("åˆªé™¤ç­æ¬¡å¤±æ•—ï¼š", error);
          alert("åˆªé™¤ç­æ¬¡å¤±æ•—ï¼š" + error.message);
        }
      }

      // ========== ç•™è¨€æ¿åŠŸèƒ½ ==========

      // æ›´æ–°ç•™è¨€æ¿æ¨™é¡Œ
      function updateMessageBoardTitle() {
        const monthNames = ['ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ'];
        const currentMonthName = `${currentDate.getFullYear()}å¹´ ${monthNames[currentDate.getMonth()]}`;
        const titleElement = document.getElementById("message-board-title");
        if (titleElement) {
          titleElement.textContent = `ğŸ’¬ ${currentMonthName} ç•™è¨€æ¿`;
        }
      }

      // è¼‰å…¥ç•™è¨€
      async function loadMessages() {
        try {
          const messageList = document.getElementById("message-list");
          messageList.innerHTML = '<div class="loading-messages">è¼‰å…¥ç•™è¨€ä¸­...</div>';

          const monthKey = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
          console.log('è¼‰å…¥ç•™è¨€ï¼Œæœˆä»½:', monthKey);

          const messagesRef = collection(db, "messages");
          const q = query(messagesRef, where("monthKey", "==", monthKey));
          const querySnapshot = await getDocs(q);

          messagesData = [];
          querySnapshot.forEach((doc) => {
            messagesData.push({ id: doc.id, ...doc.data() });
          });

          // æŒ‰æ™‚é–“æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
          messagesData.sort((a, b) => {
            const timeA = a.timestamp?.seconds || a.timestamp?.getTime() / 1000 || 0;
            const timeB = b.timestamp?.seconds || b.timestamp?.getTime() / 1000 || 0;
            return timeB - timeA;
          });

          console.log(`è¼‰å…¥ ${monthKey} çš„ç•™è¨€æ•¸é‡:`, messagesData.length);
          renderMessages();
        } catch (error) {
          console.error("è¼‰å…¥ç•™è¨€å¤±æ•—ï¼š", error);
          messagesData = [];
          renderMessages();
        }
      }

      // æ¸²æŸ“ç•™è¨€åˆ—è¡¨
      function renderMessages() {
        const messageList = document.getElementById("message-list");
        
        // å¦‚æœæœªç™»å…¥ï¼Œä¸é¡¯ç¤ºä»»ä½•å…§å®¹
        if (!currentUser) {
          messageList.innerHTML = '<div class="no-messages">è«‹å…ˆç™»å…¥ä»¥æŸ¥çœ‹ç•™è¨€</div>';
          return;
        }

        if (messagesData.length === 0) {
          messageList.innerHTML = '<div class="no-messages">æœ¬æœˆé‚„æ²’æœ‰ç•™è¨€ï¼Œæˆç‚ºç¬¬ä¸€å€‹ç•™è¨€çš„äººå§ï¼</div>';
          return;
        }

        let html = '';
        messagesData.forEach(message => {
          // è™•ç†æ™‚é–“æˆ³è¨˜ - å„ªå…ˆé¡¯ç¤ºç·¨è¼¯æ™‚é–“
          let displayDate;
          let timeLabel = '';
          
          if (message.editedAt) {
            // å¦‚æœæœ‰ç·¨è¼¯æ™‚é–“ï¼Œé¡¯ç¤ºç·¨è¼¯æ™‚é–“
            if (message.editedAt?.seconds) {
              displayDate = new Date(message.editedAt.seconds * 1000);
            } else if (message.editedAt?.getTime) {
              displayDate = message.editedAt;
            } else {
              displayDate = new Date();
            }
            timeLabel = '(å·²ç·¨è¼¯)';
          } else {
            // æ²’æœ‰ç·¨è¼¯æ™‚é–“ï¼Œé¡¯ç¤ºåŸå§‹ç™¼è¡¨æ™‚é–“
            if (message.timestamp?.seconds) {
              displayDate = new Date(message.timestamp.seconds * 1000);
            } else if (message.timestamp?.getTime) {
              displayDate = message.timestamp;
            } else {
              displayDate = new Date();
            }
          }

          const formattedTime = displayDate.toLocaleString('zh-TW', {
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
          });

          const userName = message.userEmail.split('@')[0];
          const canEdit = userRole === 'admin' || message.userId === currentUser.uid;

          html += `
            <div class="message-item">
              <div class="message-header">
                <span class="message-author">[${formattedTime}${timeLabel}] ${userName}ï¼š</span>
                ${canEdit ? `
                  <div class="message-actions">
                    <button class="message-edit-btn" onclick="editMessage('${message.id}')">ç·¨è¼¯</button>
                    <button class="message-delete-btn" onclick="deleteMessage('${message.id}')">åˆªé™¤</button>
                  </div>
                ` : ''}
              </div>
              <div class="message-content">${message.content}</div>
            </div>
          `;
        });

        messageList.innerHTML = html;
      }

      // ç™¼è¡¨ç•™è¨€
      window.submitMessage = async function() {
        // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
        if (!currentUser) {
          alert('è«‹å…ˆç™»å…¥æ‰èƒ½ç™¼è¡¨ç•™è¨€ï¼');
          return;
        }
        
        const messageInput = document.getElementById("message-input");
        const submitButton = document.getElementById("message-submit");
        
        const content = messageInput.value.trim();
        
        if (!content) {
          alert('è«‹è¼¸å…¥ç•™è¨€å…§å®¹ï¼');
          return;
        }
        
        if (content.length > 500) {
          alert('ç•™è¨€å…§å®¹ä¸èƒ½è¶…é500å­—ï¼');
          return;
        }
        
        submitButton.disabled = true;
        submitButton.textContent = 'ç™¼è¡¨ä¸­...';
        
        try {
          const monthKey = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
          
          await addDoc(collection(db, "messages"), {
            content: content,
            userId: currentUser.uid,
            userEmail: currentUser.email,
            monthKey: monthKey,
            timestamp: new Date()
          });
          
          messageInput.value = '';
          updateCharCount();
          
          console.log('ç•™è¨€ç™¼è¡¨æˆåŠŸ');
          setTimeout(loadMessages, 300);
          
        } catch (error) {
          console.error('ç™¼è¡¨ç•™è¨€å¤±æ•—ï¼š', error);
          alert('ç™¼è¡¨ç•™è¨€å¤±æ•—ï¼š' + error.message);
        } finally {
          submitButton.disabled = false;
          submitButton.textContent = 'ç™¼è¡¨ç•™è¨€';
        }
      };

      // ç·¨è¼¯ç•™è¨€ - åŠ å…¥æ›´å¤šå®‰å…¨æª¢æŸ¥
      window.editMessage = function(messageId) {
        console.log('editMessage è¢«å‘¼å«ï¼ŒmessageId:', messageId, 'currentUser:', currentUser);
        
        if (!currentUser) {
          console.log('ä½¿ç”¨è€…æœªç™»å…¥ï¼Œç„¡æ³•ç·¨è¼¯ç•™è¨€');
          alert('è«‹å…ˆç™»å…¥æ‰èƒ½ç·¨è¼¯ç•™è¨€ï¼');
          return;
        }
        
        if (!messageId) {
          console.log('messageId ç„¡æ•ˆ');
          return;
        }
        
        const message = messagesData.find(m => m.id === messageId);
        if (!message) {
          console.log('æ‰¾ä¸åˆ°å°æ‡‰çš„ç•™è¨€');
          return;
        }

        // æª¢æŸ¥æ¬Šé™
        if (userRole !== 'admin' && message.userId !== currentUser.uid) {
          alert('æ‚¨åªèƒ½ç·¨è¼¯è‡ªå·±çš„ç•™è¨€ï¼');
          return;
        }

        editingMessageId = messageId;
        const editInput = document.getElementById("edit-message-input");
        const modal = document.getElementById("edit-modal");
        
        if (editInput && modal) {
          editInput.value = message.content;
          updateEditCharCount();
          modal.classList.add("show");
        }
      };

      // å–æ¶ˆç·¨è¼¯
      window.cancelEdit = function() {
        editingMessageId = null;
        const modal = document.getElementById("edit-modal");
        if (modal) {
          modal.classList.remove("show");
        }
      };

      // å„²å­˜ç·¨è¼¯
      window.saveEdit = async function() {
        if (!editingMessageId) return;

        const editInput = document.getElementById("edit-message-input");
        const content = editInput.value.trim();

        if (!content) {
          alert('è«‹è¼¸å…¥ç•™è¨€å…§å®¹ï¼');
          return;
        }

        if (content.length > 500) {
          alert('ç•™è¨€å…§å®¹ä¸èƒ½è¶…é500å­—ï¼');
          return;
        }

        try {
          await updateDoc(doc(db, "messages", editingMessageId), {
            content: content,
            editedAt: new Date()
          });

          console.log('ç•™è¨€ç·¨è¼¯æˆåŠŸ');
          cancelEdit();
          setTimeout(loadMessages, 300);

        } catch (error) {
          console.error('ç·¨è¼¯ç•™è¨€å¤±æ•—ï¼š', error);
          alert('ç·¨è¼¯ç•™è¨€å¤±æ•—ï¼š' + error.message);
        }
      };

      // åˆªé™¤ç•™è¨€ - åŠ å…¥æ›´å¤šå®‰å…¨æª¢æŸ¥
      window.deleteMessage = async function(messageId) {
        console.log('deleteMessage è¢«å‘¼å«ï¼ŒmessageId:', messageId, 'currentUser:', currentUser);
        
        if (!currentUser) {
          console.log('ä½¿ç”¨è€…æœªç™»å…¥ï¼Œç„¡æ³•åˆªé™¤ç•™è¨€');
          alert('è«‹å…ˆç™»å…¥æ‰èƒ½åˆªé™¤ç•™è¨€ï¼');
          return;
        }
        
        if (!messageId) {
          console.log('messageId ç„¡æ•ˆ');
          return;
        }
        
        const message = messagesData.find(m => m.id === messageId);
        if (!message) {
          console.log('æ‰¾ä¸åˆ°å°æ‡‰çš„ç•™è¨€');
          return;
        }

        // æª¢æŸ¥æ¬Šé™
        if (userRole !== 'admin' && message.userId !== currentUser.uid) {
          alert('æ‚¨åªèƒ½åˆªé™¤è‡ªå·±çš„ç•™è¨€ï¼');
          return;
        }

        const userName = message.userEmail.split('@')[0];
        if (confirm(`ç¢ºå®šè¦åˆªé™¤ ${userName} çš„ç•™è¨€å—ï¼Ÿ`)) {
          try {
            await deleteDoc(doc(db, "messages", messageId));
            console.log('ç•™è¨€åˆªé™¤æˆåŠŸ');
            setTimeout(loadMessages, 300);
          } catch (error) {
            console.error('åˆªé™¤ç•™è¨€å¤±æ•—ï¼š', error);
            alert('åˆªé™¤ç•™è¨€å¤±æ•—ï¼š' + error.message);
          }
        }
      };

      // æ›´æ–°å­—æ•¸è¨ˆæ•¸
      function updateCharCount() {
        const input = document.getElementById("message-input");
        const counter = document.getElementById("char-count");
        const length = input.value.length;
        
        counter.textContent = `${length}/500`;
        
        counter.className = "char-count";
        if (length > 450) {
          counter.classList.add("danger");
        } else if (length > 400) {
          counter.classList.add("warning");
        }
      }

      // æ›´æ–°ç·¨è¼¯æ¨¡æ…‹æ¡†å­—æ•¸è¨ˆæ•¸
      function updateEditCharCount() {
        const input = document.getElementById("edit-message-input");
        const counter = document.getElementById("edit-char-count");
        const length = input.value.length;
        
        counter.textContent = `${length}/500`;
        
        counter.className = "char-count";
        if (length > 450) {
          counter.classList.add("danger");
        } else if (length > 400) {
          counter.classList.add("warning");
        }
      }

      // ç¶å®šè¼¸å…¥äº‹ä»¶
      document.addEventListener('DOMContentLoaded', function() {
        const messageInput = document.getElementById("message-input");
        const editInput = document.getElementById("edit-message-input");
        
        if (messageInput) {
          messageInput.addEventListener('input', updateCharCount);
        }
        
        if (editInput) {
          editInput.addEventListener('input', updateEditCharCount);
        }
      });

      // æ¸²æŸ“æ—¥æ›†
      function renderCalendar() {
        const calendar = document.getElementById("calendar");
        const monthNames = [
          "ä¸€æœˆ",
          "äºŒæœˆ",
          "ä¸‰æœˆ",
          "å››æœˆ",
          "äº”æœˆ",
          "å…­æœˆ",
          "ä¸ƒæœˆ",
          "å…«æœˆ",
          "ä¹æœˆ",
          "åæœˆ",
          "åä¸€æœˆ",
          "åäºŒæœˆ",
        ];

        // æ›´æ–°æœˆä»½æ¨™é¡Œ
        document.getElementById("current-month").textContent =
          currentDate.getFullYear() +
          "å¹´ " +
          monthNames[currentDate.getMonth()];

        // æ›´æ–°ç•™è¨€æ¿æ¨™é¡Œ
        updateMessageBoardTitle();

        // æ¸…é™¤ç¾æœ‰çš„æ—¥æœŸï¼ˆä¿ç•™æ¨™é¡Œï¼‰
        const existingElements = calendar.querySelectorAll(
          ".calendar-day, .week-button"
        );
        existingElements.forEach((element) => element.remove());

        // è¨ˆç®—æœˆä»½çš„ç¬¬ä¸€å¤©
        const firstDay = new Date(
          currentDate.getFullYear(),
          currentDate.getMonth(),
          1
        );

        // æ‰¾åˆ°é€™å€‹æœˆç¬¬ä¸€å€‹é€±ä¸€
        const startDate = new Date(firstDay);
        const dayOfWeek = firstDay.getDay(); // 0=é€±æ—¥, 1=é€±ä¸€, ..., 6=é€±å…­
        const daysToSubtract = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // é€±æ—¥çš„è©±è¦æ¸›6å¤©æ‰åˆ°é€±ä¸€
        startDate.setDate(firstDay.getDate() - daysToSubtract);

        // ç”Ÿæˆ6é€±çš„æ—¥æ›†
        for (let week = 0; week < 6; week++) {
          // å‰µå»ºé€±çš„é–‹å§‹æ—¥æœŸï¼ˆé€±ä¸€ï¼‰
          const weekStartDate = new Date(startDate);
          weekStartDate.setDate(startDate.getDate() + week * 7);

          // æ·»åŠ é€±æŒ‰éˆ•
          const weekButton = document.createElement("div");
          weekButton.className = "week-button";

          const button = document.createElement("button");
          button.textContent = "å¡«æ»¿æ•´é€±";
          button.onclick = () => fillWeekFromDate(weekStartDate);

          weekButton.appendChild(button);
          calendar.appendChild(weekButton);

          // æ·»åŠ é€™é€±çš„7å¤©ï¼ˆé€±ä¸€åˆ°é€±æ—¥ï¼‰
          for (let day = 0; day < 7; day++) {
            const date = new Date(weekStartDate);
            date.setDate(weekStartDate.getDate() + day);

            const dayElement = document.createElement("div");
            dayElement.className = "calendar-day";

            const dayNumber = document.createElement("div");
            dayNumber.className = "day-number";
            dayNumber.textContent = date.getDate();

            const shiftInfo = document.createElement("div");
            shiftInfo.className = "shift-info";

            // æª¢æŸ¥é€™ä¸€å¤©æ˜¯å¦æœ‰ç­æ¬¡
            const dateStr = date.toISOString().split("T")[0];
            const dayShift = shiftsData.find((shift) => shift.date === dateStr);

            if (dayShift) {
              shiftInfo.textContent = dayShift.userEmail.split("@")[0];
              if (dayShift.userId === currentUser.uid) {
                dayElement.classList.add("my-shift");
              } else {
                dayElement.classList.add("occupied");
              }
            }

            // å¦‚æœä¸æ˜¯ç•¶å‰æœˆä»½ï¼Œè¨­ç‚ºç°è‰²
            if (date.getMonth() !== currentDate.getMonth()) {
              dayElement.style.opacity = "0.3";
            }

            // é€±æœ«ï¼ˆé€±å…­ã€é€±æ—¥ï¼‰å¯ä»¥ç”¨ä¸åŒé¡è‰²å€åˆ¥
            if (day === 5 || day === 6) {
              // é€±å…­ã€é€±æ—¥
              dayElement.style.backgroundColor = "#f0f8ff";
            }

            // é»æ“Šäº‹ä»¶
            dayElement.addEventListener("click", () =>
              handleDayClick(dateStr, dayShift)
            );

            dayElement.appendChild(dayNumber);
            dayElement.appendChild(shiftInfo);
            calendar.appendChild(dayElement);
          }
        }
      }

      // è™•ç†æ—¥æœŸé»æ“Š
      function handleDayClick(dateStr, existingShift) {
        // åªè®€ä½¿ç”¨è€…ä¸èƒ½ä¿®æ”¹ç­è¡¨
        if (userRole === "readonly") {
          alert("æ‚¨æ˜¯åªè®€æ¬Šé™ï¼Œç„¡æ³•ä¿®æ”¹ç­è¡¨ã€‚");
          return;
        }

        if (existingShift) {
          // ç®¡ç†å“¡å¯ä»¥åˆªé™¤ä»»ä½•äººçš„ç­æ¬¡
          if (userRole === "admin") {
            const userName = existingShift.userEmail.split("@")[0];
            if (confirm(`ç¢ºå®šè¦åˆªé™¤ ${userName} åœ¨é€™å¤©çš„ç­æ¬¡å—ï¼Ÿ`)) {
              removeShift(existingShift.id);
            }
          } else if (existingShift.userId === currentUser.uid) {
            // ä¸€èˆ¬ä½¿ç”¨è€…åªèƒ½åˆªé™¤è‡ªå·±çš„ç­æ¬¡
            if (confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹ç­æ¬¡å—ï¼Ÿ")) {
              removeShift(existingShift.id);
            }
          } else {
            alert("é€™å¤©å·²ç¶“æœ‰å…¶ä»–äººæ’ç­äº†ï¼");
          }
        } else {
          // æ–°å¢ç­æ¬¡
          addShift(dateStr);
        }
      }

      // ä¸Šå€‹æœˆ
      window.previousMonth = function () {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
        loadMessages(); // è¼‰å…¥æ–°æœˆä»½çš„ç•™è¨€
      };

      // ä¸‹å€‹æœˆ
      window.nextMonth = function () {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
        loadMessages(); // è¼‰å…¥æ–°æœˆä»½çš„ç•™è¨€
      };

      // å¡«æ»¿æŒ‡å®šé€±
      async function fillWeekFromDate(startDate) {
        // åªè®€ä½¿ç”¨è€…ä¸èƒ½ä¿®æ”¹ç­è¡¨
        if (userRole === "readonly") {
          alert("æ‚¨æ˜¯åªè®€æ¬Šé™ï¼Œç„¡æ³•ä¿®æ”¹ç­è¡¨ã€‚");
          return;
        }

        console.log("é–‹å§‹å¡«æ»¿é€±:", startDate); // é™¤éŒ¯ç”¨

        for (let i = 0; i < 7; i++) {
          const date = new Date(startDate);
          date.setDate(startDate.getDate() + i);
          const dateStr = date.toISOString().split("T")[0];

          console.log("æª¢æŸ¥æ—¥æœŸ:", dateStr); // é™¤éŒ¯ç”¨

          // æª¢æŸ¥é€™å¤©æ˜¯å¦å·²ç¶“æœ‰äººæ’ç­
          const existingShift = shiftsData.find(
            (shift) => shift.date === dateStr
          );
          if (!existingShift) {
            console.log("æ–°å¢ç­æ¬¡:", dateStr); // é™¤éŒ¯ç”¨
            try {
              await addShift(dateStr);
              // åŠ å…¥å°å»¶é²ï¼Œé¿å…åŒæ™‚ç™¼é€å¤ªå¤šè«‹æ±‚
              await new Promise((resolve) => setTimeout(resolve, 100));
            } catch (error) {
              console.error("æ–°å¢ç­æ¬¡å¤±æ•—:", dateStr, error);
            }
          } else {
            console.log("å·²æœ‰äººæ’ç­:", dateStr, existingShift.userEmail); // é™¤éŒ¯ç”¨
          }
        }

        alert("å¡«æ»¿æ•´é€±å®Œæˆï¼");
      }

      // ç®¡ç†å“¡åŠŸèƒ½ï¼šæ¸…é™¤æ‰€æœ‰äººé€™å€‹æœˆçš„ç­æ¬¡
      window.clearAllMonthlyShifts = async function () {
        if (userRole !== "admin") {
          alert("åªæœ‰ç®¡ç†å“¡å¯ä»¥ä½¿ç”¨æ­¤åŠŸèƒ½ï¼");
          return;
        }

        const monthNames = [
          "ä¸€æœˆ",
          "äºŒæœˆ",
          "ä¸‰æœˆ",
          "å››æœˆ",
          "äº”æœˆ",
          "å…­æœˆ",
          "ä¸ƒæœˆ",
          "å…«æœˆ",
          "ä¹æœˆ",
          "åæœˆ",
          "åä¸€æœˆ",
          "åäºŒæœˆ",
        ];
        const currentMonthName =
          currentDate.getFullYear() +
          "å¹´ " +
          monthNames[currentDate.getMonth()];

        if (
          confirm(
            `âš ï¸ ç®¡ç†å“¡æ¬Šé™ âš ï¸\n\nç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰äººåœ¨ ${currentMonthName} çš„ç­æ¬¡å—ï¼Ÿ\n\né€™å€‹å‹•ä½œç„¡æ³•å¾©åŸï¼`
          )
        ) {
          // è¨ˆç®—ç•¶æœˆçš„æ—¥æœŸç¯„åœ
          const year = currentDate.getFullYear();
          const month = currentDate.getMonth();
          const startOfMonth = new Date(year, month, 1);
          const endOfMonth = new Date(year, month + 1, 0);

          const startDateStr = startOfMonth.toISOString().split("T")[0];
          const endDateStr = endOfMonth.toISOString().split("T")[0];

          // æ‰¾å‡ºé€™å€‹æœˆæ‰€æœ‰äººçš„ç­æ¬¡
          const allMonthlyShifts = shiftsData.filter(
            (shift) => shift.date >= startDateStr && shift.date <= endDateStr
          );

          if (allMonthlyShifts.length === 0) {
            alert("é€™å€‹æœˆæ²’æœ‰ä»»ä½•ç­æ¬¡è¨˜éŒ„ã€‚");
            return;
          }

          // é€ä¸€åˆªé™¤
          for (const shift of allMonthlyShifts) {
            try {
              await removeShift(shift.id);
              await new Promise((resolve) => setTimeout(resolve, 100));
            } catch (error) {
              console.error("åˆªé™¤ç­æ¬¡å¤±æ•—:", shift.date, error);
            }
          }

          alert(`å·²æ¸…é™¤ ${allMonthlyShifts.length} å€‹ç­æ¬¡ï¼`);
        }
      };

      // ç®¡ç†å“¡åŠŸèƒ½ï¼šæŸ¥çœ‹æœˆåº¦çµ±è¨ˆ
      window.showMonthlyStats = function () {
        if (userRole !== "admin") {
          alert("åªæœ‰ç®¡ç†å“¡å¯ä»¥ä½¿ç”¨æ­¤åŠŸèƒ½ï¼");
          return;
        }

        const monthNames = [
          "ä¸€æœˆ",
          "äºŒæœˆ",
          "ä¸‰æœˆ",
          "å››æœˆ",
          "äº”æœˆ",
          "å…­æœˆ",
          "ä¸ƒæœˆ",
          "å…«æœˆ",
          "ä¹æœˆ",
          "åæœˆ",
          "åä¸€æœˆ",
          "åäºŒæœˆ",
        ];
        const currentMonthName =
          currentDate.getFullYear() +
          "å¹´ " +
          monthNames[currentDate.getMonth()];

        // è¨ˆç®—ç•¶æœˆçš„æ—¥æœŸç¯„åœ
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const startOfMonth = new Date(year, month, 1);
        const endOfMonth = new Date(year, month + 1, 0);

        const startDateStr = startOfMonth.toISOString().split("T")[0];
        const endDateStr = endOfMonth.toISOString().split("T")[0];

        // çµ±è¨ˆæ¯å€‹äººçš„ç­æ¬¡
        const stats = {};
        const monthlyShifts = shiftsData.filter(
          (shift) => shift.date >= startDateStr && shift.date <= endDateStr
        );

        monthlyShifts.forEach((shift) => {
          const email = shift.userEmail;
          if (!stats[email]) {
            stats[email] = 0;
          }
          stats[email]++;
        });

        // å»ºç«‹çµ±è¨ˆå ±å‘Š
        let report = `ğŸ“Š ${currentMonthName} ç­æ¬¡çµ±è¨ˆ\n\n`;

        if (Object.keys(stats).length === 0) {
          report += "é€™å€‹æœˆé‚„æ²’æœ‰ä»»ä½•ç­æ¬¡è¨˜éŒ„ã€‚";
        } else {
          Object.entries(stats)
            .sort((a, b) => b[1] - a[1]) // æŒ‰ç­æ¬¡æ•¸é‡æ’åº
            .forEach(([email, count]) => {
              const name = email.split("@")[0];
              report += `${name}: ${count} å¤©\n`;
            });

          const totalDays = Object.values(stats).reduce(
            (sum, count) => sum + count,
            0
          );
          report += `\nç¸½å…±: ${totalDays} å¤©`;
        }

        alert(report);
      };

      // æ¸…é™¤æˆ‘é€™å€‹æœˆçš„æ‰€æœ‰ç­æ¬¡
      window.clearMyMonthlyShifts = async function () {
        // åªè®€ä½¿ç”¨è€…ä¸èƒ½ä¿®æ”¹ç­è¡¨
        if (userRole === "readonly") {
          alert("æ‚¨æ˜¯åªè®€æ¬Šé™ï¼Œç„¡æ³•ä¿®æ”¹ç­è¡¨ã€‚");
          return;
        }

        const monthNames = [
          "ä¸€æœˆ",
          "äºŒæœˆ",
          "ä¸‰æœˆ",
          "å››æœˆ",
          "äº”æœˆ",
          "å…­æœˆ",
          "ä¸ƒæœˆ",
          "å…«æœˆ",
          "ä¹æœˆ",
          "åæœˆ",
          "åä¸€æœˆ",
          "åäºŒæœˆ",
        ];
        const currentMonthName =
          currentDate.getFullYear() +
          "å¹´ " +
          monthNames[currentDate.getMonth()];

        if (confirm(`ç¢ºå®šè¦æ¸…é™¤æ‚¨åœ¨ ${currentMonthName} çš„æ‰€æœ‰ç­æ¬¡å—ï¼Ÿ`)) {
          // è¨ˆç®—ç•¶æœˆçš„æ—¥æœŸç¯„åœ
          const year = currentDate.getFullYear();
          const month = currentDate.getMonth();
          const startOfMonth = new Date(year, month, 1);
          const endOfMonth = new Date(year, month + 1, 0);

          const startDateStr = startOfMonth.toISOString().split("T")[0];
          const endDateStr = endOfMonth.toISOString().split("T")[0];

          console.log(`æ¸…é™¤ ${startDateStr} åˆ° ${endDateStr} çš„ç­æ¬¡`);

          // æ‰¾å‡ºé€™å€‹æœˆæˆ‘çš„æ‰€æœ‰ç­æ¬¡
          const myMonthlyShifts = shiftsData.filter(
            (shift) =>
              shift.userId === currentUser.uid &&
              shift.date >= startDateStr &&
              shift.date <= endDateStr
          );

          console.log("æ‰¾åˆ°ç­æ¬¡æ•¸é‡:", myMonthlyShifts.length);

          if (myMonthlyShifts.length === 0) {
            alert("æ‚¨åœ¨é€™å€‹æœˆæ²’æœ‰æ’ç­è¨˜éŒ„ã€‚");
            return;
          }

          // é€ä¸€åˆªé™¤
          for (const shift of myMonthlyShifts) {
            try {
              await removeShift(shift.id);
              // åŠ å…¥å°å»¶é²é¿å…è«‹æ±‚éæ–¼é »ç¹
              await new Promise((resolve) => setTimeout(resolve, 100));
            } catch (error) {
              console.error("åˆªé™¤ç­æ¬¡å¤±æ•—:", shift.date, error);
            }
          }

          alert(`å·²æ¸…é™¤ ${myMonthlyShifts.length} å€‹ç­æ¬¡ï¼`);
        }
      };

      // åˆå§‹åŒ–
      renderCalendar();
    </script>
  </body>
</html>