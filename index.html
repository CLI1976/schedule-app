<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ’ç­ç³»çµ±</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .auth-section {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .calendar-section {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .calendar {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 2px;
        margin-top: 20px;
      }

      .calendar-header {
        background: #4caf50;
        color: white;
        padding: 10px;
        text-align: center;
        font-weight: bold;
      }

      .week-button-header {
        background: #ff9800;
        color: white;
        padding: 10px;
        text-align: center;
        font-weight: bold;
        font-size: 12px;
      }

      .week-button {
        background: #fff3e0;
        border: 1px solid #ff9800;
        min-height: 80px;
        padding: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .week-button:hover {
        background: #ffe0b2;
      }

      .week-button button {
        background: #ff9800;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 11px;
        white-space: nowrap;
      }

      .week-button button:hover {
        background: #f57c00;
      }

      .calendar-day {
        background: #f9f9f9;
        border: 1px solid #ddd;
        min-height: 80px;
        padding: 5px;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .calendar-day:hover {
        background: #e8f5e8;
      }

      .calendar-day.occupied {
        background: #ffcdd2;
      }

      .calendar-day.my-shift {
        background: #c8e6c9;
      }

      .day-number {
        font-weight: bold;
        margin-bottom: 5px;
      }

      .shift-info {
        font-size: 12px;
        color: #666;
      }

      .controls {
        margin-bottom: 20px;
        text-align: center;
      }

      .controls button {
        margin: 5px;
        padding: 10px 15px;
        background: #4caf50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      .controls button:hover {
        background: #45a049;
      }

      .month-navigation {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .month-navigation button {
        padding: 10px 15px;
        background: #2196f3;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      .month-navigation button:hover {
        background: #1976d2;
      }

      .current-month {
        font-size: 18px;
        font-weight: bold;
      }

      .hidden {
        display: none;
      }

      .error {
        color: red;
        margin-top: 10px;
      }

      .success {
        color: green;
        margin-top: 10px;
      }

      input[type="email"],
      input[type="password"] {
        width: 200px;
        padding: 8px;
        margin: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      button {
        padding: 8px 15px;
        margin: 5px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      .primary-button {
        background: #4caf50;
        color: white;
      }

      .primary-button:hover {
        background: #45a049;
      }

      .secondary-button {
        background: #f44336;
        color: white;
      }

      .secondary-button:hover {
        background: #d32f2f;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>ğŸ—“ï¸ æ’ç­ç³»çµ±</h1>
      <p>é»æ“Šæ—¥æœŸä¾†æ–°å¢æˆ–åˆªé™¤æ‚¨çš„ç­æ¬¡</p>
    </div>

    <!-- ç™»å…¥/è¨»å†Šå€åŸŸ -->
    <div id="auth-section" class="auth-section">
      <h3>è«‹å…ˆç™»å…¥æˆ–è¨»å†Š</h3>
      <div>
        <input type="email" id="email" placeholder="é›»å­éƒµä»¶" />
        <input type="password" id="password" placeholder="å¯†ç¢¼" />
      </div>
      <div>
        <button class="primary-button" onclick="signIn()">ç™»å…¥</button>
        <button class="primary-button" onclick="signUp()">è¨»å†Š</button>
      </div>
      <div id="auth-message"></div>
    </div>

    <!-- ä¸»è¦åŠŸèƒ½å€åŸŸ -->
    <div id="main-section" class="calendar-section hidden">
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 20px;
        "
      >
        <div>
          <span>æ­¡è¿ï¼Œ</span><span id="user-email"></span>
          <span id="role-display" style="margin-left: 10px"></span>
          <button class="secondary-button" onclick="signOut()">ç™»å‡º</button>
        </div>
      </div>

      <div class="controls">
        <button onclick="clearMyMonthlyShifts()">æ¸…é™¤æˆ‘é€™å€‹æœˆçš„æ‰€æœ‰ç­æ¬¡</button>
      </div>

      <div class="month-navigation">
        <button onclick="previousMonth()">Â« ä¸Šå€‹æœˆ</button>
        <div class="current-month" id="current-month"></div>
        <button onclick="nextMonth()">ä¸‹å€‹æœˆ Â»</button>
      </div>

      <div class="calendar" id="calendar">
        <!-- æ—¥æ›†æ¨™é¡Œ -->
        <div class="week-button-header">æ’ç­</div>
        <div class="calendar-header">ä¸€</div>
        <div class="calendar-header">äºŒ</div>
        <div class="calendar-header">ä¸‰</div>
        <div class="calendar-header">å››</div>
        <div class="calendar-header">äº”</div>
        <div class="calendar-header">å…­</div>
        <div class="calendar-header">æ—¥</div>
      </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
      // TODO: è«‹å°‡ä¸‹é¢çš„ firebaseConfig æ›¿æ›æˆæ‚¨å¾ Firebase æ§åˆ¶å°å–å¾—çš„é…ç½®
      const firebaseConfig = {
        apiKey: "AIzaSyDcX1hjA9_qyb6kYgYbQaRblwFrXdW-hWo",
        authDomain: "mchplainfilmschedule.firebaseapp.com",
        projectId: "mchplainfilmschedule",
        storageBucket: "mchplainfilmschedule.firebasestorage.app",
        messagingSenderId: "104675634969",
        appId: "1:104675634969:web:3816e35be9d4a551415f88",
        measurementId: "G-5T31DSRENK",
      };

      // å°å…¥ Firebase åŠŸèƒ½
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getAuth,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut as firebaseSignOut,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        addDoc,
        query,
        where,
        getDocs,
        deleteDoc,
        doc,
        orderBy,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      // åˆå§‹åŒ– Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // å…¨åŸŸè®Šæ•¸
      let currentDate = new Date();
      let currentUser = null;
      let shiftsData = [];
      let userRole = "normal"; // é è¨­ç‚ºä¸€èˆ¬ä½¿ç”¨è€…

      // æ¬Šé™è¨­å®š
      const ADMIN_EMAILS = [
        "hw98188@gmail.com",
        // åœ¨é€™è£¡åŠ å…¥ç®¡ç†å“¡ email
      ];

      const READONLY_EMAILS = [
        "guest@company.com",
        // åœ¨é€™è£¡åŠ å…¥åªè®€æ¬Šé™çš„ email
      ];

      // æª¢æŸ¥ä½¿ç”¨è€…æ¬Šé™
      function getUserRole(email) {
        if (ADMIN_EMAILS.includes(email)) {
          return "admin";
        } else if (READONLY_EMAILS.includes(email)) {
          return "readonly";
        } else {
          return "normal";
        }
      }

      // ç›£è½èªè­‰ç‹€æ…‹è®ŠåŒ–
      onAuthStateChanged(auth, (user) => {
        if (user) {
          currentUser = user;
          userRole = getUserRole(user.email);

          document.getElementById("auth-section").classList.add("hidden");
          document.getElementById("main-section").classList.remove("hidden");

          // æ›´æ–°ä½¿ç”¨è€…è³‡è¨Šé¡¯ç¤º
          updateUserInterface();
          loadShifts();
        } else {
          currentUser = null;
          userRole = "normal";
          document.getElementById("auth-section").classList.remove("hidden");
          document.getElementById("main-section").classList.add("hidden");
        }
      });

      // æ›´æ–°ä½¿ç”¨è€…ä»‹é¢
      function updateUserInterface() {
        const userEmail = document.getElementById("user-email");
        const roleDisplay = document.getElementById("role-display");

        let roleText = "";
        let roleColor = "";

        switch (userRole) {
          case "admin":
            roleText = "ğŸ‘‘ ç®¡ç†å“¡";
            roleColor = "#ff6b6b";
            break;
          case "readonly":
            roleText = "ğŸ‘ï¸ åªè®€æ¬Šé™";
            roleColor = "#74b9ff";
            break;
          default:
            roleText = "ğŸ‘¤ ä¸€èˆ¬ä½¿ç”¨è€…";
            roleColor = "#00b894";
        }

        userEmail.textContent = currentUser.email;
        roleDisplay.textContent = roleText;
        roleDisplay.style.color = roleColor;
        roleDisplay.style.fontWeight = "bold";

        // æ ¹æ“šæ¬Šé™é¡¯ç¤º/éš±è—æ§åˆ¶æŒ‰éˆ•
        updateControlsVisibility();
      }

      // æ ¹æ“šæ¬Šé™æ›´æ–°æ§åˆ¶æŒ‰éˆ•
      function updateControlsVisibility() {
        const controls = document.querySelector(".controls");

        if (userRole === "readonly") {
          // åªè®€ä½¿ç”¨è€…éš±è—æ‰€æœ‰æ§åˆ¶æŒ‰éˆ•
          controls.style.display = "none";
        } else {
          controls.style.display = "block";

          // ç®¡ç†å“¡é¡¯ç¤ºé¡å¤–åŠŸèƒ½
          if (userRole === "admin") {
            addAdminControls();
          }
        }
      }

      // æ–°å¢ç®¡ç†å“¡å°ˆç”¨æ§åˆ¶æŒ‰éˆ•
      function addAdminControls() {
        const controls = document.querySelector(".controls");

        // æª¢æŸ¥æ˜¯å¦å·²ç¶“åŠ å…¥ç®¡ç†å“¡æŒ‰éˆ•
        if (!document.getElementById("admin-controls")) {
          const adminDiv = document.createElement("div");
          adminDiv.id = "admin-controls";
          adminDiv.style.marginTop = "10px";
          adminDiv.style.padding = "10px";
          adminDiv.style.backgroundColor = "#fff5f5";
          adminDiv.style.border = "2px solid #ff6b6b";
          adminDiv.style.borderRadius = "5px";

          adminDiv.innerHTML = `
                    <div style="color: #ff6b6b; font-weight: bold; margin-bottom: 10px;">ğŸ‘‘ ç®¡ç†å“¡åŠŸèƒ½</div>
                    <button onclick="clearAllMonthlyShifts()" style="background: #ff6b6b; margin: 5px;">æ¸…é™¤æ‰€æœ‰äººé€™å€‹æœˆçš„ç­æ¬¡</button>
                    <button onclick="showMonthlyStats()" style="background: #0984e3; margin: 5px;">æŸ¥çœ‹æœˆåº¦çµ±è¨ˆ</button>
                `;

          controls.appendChild(adminDiv);
        }
      }

      // è¨»å†ŠåŠŸèƒ½
      window.signUp = async function () {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const messageDiv = document.getElementById("auth-message");

        try {
          await createUserWithEmailAndPassword(auth, email, password);
          messageDiv.innerHTML = '<div class="success">è¨»å†ŠæˆåŠŸï¼</div>';
        } catch (error) {
          messageDiv.innerHTML =
            '<div class="error">è¨»å†Šå¤±æ•—ï¼š' + error.message + "</div>";
        }
      };

      // ç™»å…¥åŠŸèƒ½
      window.signIn = async function () {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const messageDiv = document.getElementById("auth-message");

        try {
          await signInWithEmailAndPassword(auth, email, password);
          messageDiv.innerHTML = '<div class="success">ç™»å…¥æˆåŠŸï¼</div>';
        } catch (error) {
          messageDiv.innerHTML =
            '<div class="error">ç™»å…¥å¤±æ•—ï¼š' + error.message + "</div>";
        }
      };

      // ç™»å‡ºåŠŸèƒ½
      window.signOut = async function () {
        try {
          await firebaseSignOut(auth);
        } catch (error) {
          console.error("ç™»å‡ºå¤±æ•—ï¼š", error);
        }
      };

      // è¼‰å…¥ç­è¡¨æ•¸æ“š
      async function loadShifts() {
        try {
          const shiftsRef = collection(db, "shifts");
          const q = query(shiftsRef, orderBy("date"));
          const querySnapshot = await getDocs(q);

          shiftsData = [];
          querySnapshot.forEach((doc) => {
            shiftsData.push({ id: doc.id, ...doc.data() });
          });

          renderCalendar();
        } catch (error) {
          console.error("è¼‰å…¥ç­è¡¨å¤±æ•—ï¼š", error);
        }
      }

      // æ–°å¢ç­æ¬¡
      async function addShift(dateStr) {
        try {
          await addDoc(collection(db, "shifts"), {
            date: dateStr,
            userId: currentUser.uid,
            userEmail: currentUser.email,
            timestamp: new Date(),
          });
          loadShifts();
        } catch (error) {
          console.error("æ–°å¢ç­æ¬¡å¤±æ•—ï¼š", error);
          alert("æ–°å¢ç­æ¬¡å¤±æ•—ï¼š" + error.message);
        }
      }

      // åˆªé™¤ç­æ¬¡
      async function removeShift(shiftId) {
        try {
          await deleteDoc(doc(db, "shifts", shiftId));
          loadShifts();
        } catch (error) {
          console.error("åˆªé™¤ç­æ¬¡å¤±æ•—ï¼š", error);
          alert("åˆªé™¤ç­æ¬¡å¤±æ•—ï¼š" + error.message);
        }
      }

      // æ¸²æŸ“æ—¥æ›†
      function renderCalendar() {
        const calendar = document.getElementById("calendar");
        const monthNames = [
          "ä¸€æœˆ",
          "äºŒæœˆ",
          "ä¸‰æœˆ",
          "å››æœˆ",
          "äº”æœˆ",
          "å…­æœˆ",
          "ä¸ƒæœˆ",
          "å…«æœˆ",
          "ä¹æœˆ",
          "åæœˆ",
          "åä¸€æœˆ",
          "åäºŒæœˆ",
        ];

        // æ›´æ–°æœˆä»½æ¨™é¡Œ
        document.getElementById("current-month").textContent =
          currentDate.getFullYear() +
          "å¹´ " +
          monthNames[currentDate.getMonth()];

        // æ¸…é™¤ç¾æœ‰çš„æ—¥æœŸï¼ˆä¿ç•™æ¨™é¡Œï¼‰
        const existingElements = calendar.querySelectorAll(
          ".calendar-day, .week-button"
        );
        existingElements.forEach((element) => element.remove());

        // è¨ˆç®—æœˆä»½çš„ç¬¬ä¸€å¤©
        const firstDay = new Date(
          currentDate.getFullYear(),
          currentDate.getMonth(),
          1
        );

        // æ‰¾åˆ°é€™å€‹æœˆç¬¬ä¸€å€‹é€±ä¸€
        const startDate = new Date(firstDay);
        const dayOfWeek = firstDay.getDay(); // 0=é€±æ—¥, 1=é€±ä¸€, ..., 6=é€±å…­
        const daysToSubtract = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // é€±æ—¥çš„è©±è¦æ¸›6å¤©æ‰åˆ°é€±ä¸€
        startDate.setDate(firstDay.getDate() - daysToSubtract);

        // ç”Ÿæˆ6é€±çš„æ—¥æ›†
        for (let week = 0; week < 6; week++) {
          // å‰µå»ºé€±çš„é–‹å§‹æ—¥æœŸï¼ˆé€±ä¸€ï¼‰
          const weekStartDate = new Date(startDate);
          weekStartDate.setDate(startDate.getDate() + week * 7);

          // æ·»åŠ é€±æŒ‰éˆ•
          const weekButton = document.createElement("div");
          weekButton.className = "week-button";

          const button = document.createElement("button");
          button.textContent = "å¡«æ»¿æ•´é€±";
          button.onclick = () => fillWeekFromDate(weekStartDate);

          weekButton.appendChild(button);
          calendar.appendChild(weekButton);

          // æ·»åŠ é€™é€±çš„7å¤©ï¼ˆé€±ä¸€åˆ°é€±æ—¥ï¼‰
          for (let day = 0; day < 7; day++) {
            const date = new Date(weekStartDate);
            date.setDate(weekStartDate.getDate() + day);

            const dayElement = document.createElement("div");
            dayElement.className = "calendar-day";

            const dayNumber = document.createElement("div");
            dayNumber.className = "day-number";
            dayNumber.textContent = date.getDate();

            const shiftInfo = document.createElement("div");
            shiftInfo.className = "shift-info";

            // æª¢æŸ¥é€™ä¸€å¤©æ˜¯å¦æœ‰ç­æ¬¡
            const dateStr = date.toISOString().split("T")[0];
            const dayShift = shiftsData.find((shift) => shift.date === dateStr);

            if (dayShift) {
              shiftInfo.textContent = dayShift.userEmail.split("@")[0];
              if (dayShift.userId === currentUser.uid) {
                dayElement.classList.add("my-shift");
              } else {
                dayElement.classList.add("occupied");
              }
            }

            // å¦‚æœä¸æ˜¯ç•¶å‰æœˆä»½ï¼Œè¨­ç‚ºç°è‰²
            if (date.getMonth() !== currentDate.getMonth()) {
              dayElement.style.opacity = "0.3";
            }

            // é€±æœ«ï¼ˆé€±å…­ã€é€±æ—¥ï¼‰å¯ä»¥ç”¨ä¸åŒé¡è‰²å€åˆ¥
            if (day === 5 || day === 6) {
              // é€±å…­ã€é€±æ—¥
              dayElement.style.backgroundColor = "#f0f8ff";
            }

            // é»æ“Šäº‹ä»¶
            dayElement.addEventListener("click", () =>
              handleDayClick(dateStr, dayShift)
            );

            dayElement.appendChild(dayNumber);
            dayElement.appendChild(shiftInfo);
            calendar.appendChild(dayElement);
          }
        }
      }

      // è™•ç†æ—¥æœŸé»æ“Š
      function handleDayClick(dateStr, existingShift) {
        // åªè®€ä½¿ç”¨è€…ä¸èƒ½ä¿®æ”¹ç­è¡¨
        if (userRole === "readonly") {
          alert("æ‚¨æ˜¯åªè®€æ¬Šé™ï¼Œç„¡æ³•ä¿®æ”¹ç­è¡¨ã€‚");
          return;
        }

        if (existingShift) {
          // ç®¡ç†å“¡å¯ä»¥åˆªé™¤ä»»ä½•äººçš„ç­æ¬¡
          if (userRole === "admin") {
            const userName = existingShift.userEmail.split("@")[0];
            if (confirm(`ç¢ºå®šè¦åˆªé™¤ ${userName} åœ¨é€™å¤©çš„ç­æ¬¡å—ï¼Ÿ`)) {
              removeShift(existingShift.id);
            }
          } else if (existingShift.userId === currentUser.uid) {
            // ä¸€èˆ¬ä½¿ç”¨è€…åªèƒ½åˆªé™¤è‡ªå·±çš„ç­æ¬¡
            if (confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹ç­æ¬¡å—ï¼Ÿ")) {
              removeShift(existingShift.id);
            }
          } else {
            alert("é€™å¤©å·²ç¶“æœ‰å…¶ä»–äººæ’ç­äº†ï¼");
          }
        } else {
          // æ–°å¢ç­æ¬¡
          addShift(dateStr);
        }
      }

      // ä¸Šå€‹æœˆ
      window.previousMonth = function () {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
      };

      // ä¸‹å€‹æœˆ
      window.nextMonth = function () {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
      };

      // å¡«æ»¿æŒ‡å®šé€±
      async function fillWeekFromDate(startDate) {
        // åªè®€ä½¿ç”¨è€…ä¸èƒ½ä¿®æ”¹ç­è¡¨
        if (userRole === "readonly") {
          alert("æ‚¨æ˜¯åªè®€æ¬Šé™ï¼Œç„¡æ³•ä¿®æ”¹ç­è¡¨ã€‚");
          return;
        }

        console.log("é–‹å§‹å¡«æ»¿é€±:", startDate); // é™¤éŒ¯ç”¨

        for (let i = 0; i < 7; i++) {
          const date = new Date(startDate);
          date.setDate(startDate.getDate() + i);
          const dateStr = date.toISOString().split("T")[0];

          console.log("æª¢æŸ¥æ—¥æœŸ:", dateStr); // é™¤éŒ¯ç”¨

          // æª¢æŸ¥é€™å¤©æ˜¯å¦å·²ç¶“æœ‰äººæ’ç­
          const existingShift = shiftsData.find(
            (shift) => shift.date === dateStr
          );
          if (!existingShift) {
            console.log("æ–°å¢ç­æ¬¡:", dateStr); // é™¤éŒ¯ç”¨
            try {
              await addShift(dateStr);
              // åŠ å…¥å°å»¶é²ï¼Œé¿å…åŒæ™‚ç™¼é€å¤ªå¤šè«‹æ±‚
              await new Promise((resolve) => setTimeout(resolve, 100));
            } catch (error) {
              console.error("æ–°å¢ç­æ¬¡å¤±æ•—:", dateStr, error);
            }
          } else {
            console.log("å·²æœ‰äººæ’ç­:", dateStr, existingShift.userEmail); // é™¤éŒ¯ç”¨
          }
        }

        alert("å¡«æ»¿æ•´é€±å®Œæˆï¼");
      }

      // ç®¡ç†å“¡åŠŸèƒ½ï¼šæ¸…é™¤æ‰€æœ‰äººé€™å€‹æœˆçš„ç­æ¬¡
      window.clearAllMonthlyShifts = async function () {
        if (userRole !== "admin") {
          alert("åªæœ‰ç®¡ç†å“¡å¯ä»¥ä½¿ç”¨æ­¤åŠŸèƒ½ï¼");
          return;
        }

        const monthNames = [
          "ä¸€æœˆ",
          "äºŒæœˆ",
          "ä¸‰æœˆ",
          "å››æœˆ",
          "äº”æœˆ",
          "å…­æœˆ",
          "ä¸ƒæœˆ",
          "å…«æœˆ",
          "ä¹æœˆ",
          "åæœˆ",
          "åä¸€æœˆ",
          "åäºŒæœˆ",
        ];
        const currentMonthName =
          currentDate.getFullYear() +
          "å¹´ " +
          monthNames[currentDate.getMonth()];

        if (
          confirm(
            `âš ï¸ ç®¡ç†å“¡æ¬Šé™ âš ï¸\n\nç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰äººåœ¨ ${currentMonthName} çš„ç­æ¬¡å—ï¼Ÿ\n\né€™å€‹å‹•ä½œç„¡æ³•å¾©åŸï¼`
          )
        ) {
          // è¨ˆç®—ç•¶æœˆçš„æ—¥æœŸç¯„åœ
          const year = currentDate.getFullYear();
          const month = currentDate.getMonth();
          const startOfMonth = new Date(year, month, 1);
          const endOfMonth = new Date(year, month + 1, 0);

          const startDateStr = startOfMonth.toISOString().split("T")[0];
          const endDateStr = endOfMonth.toISOString().split("T")[0];

          // æ‰¾å‡ºé€™å€‹æœˆæ‰€æœ‰äººçš„ç­æ¬¡
          const allMonthlyShifts = shiftsData.filter(
            (shift) => shift.date >= startDateStr && shift.date <= endDateStr
          );

          if (allMonthlyShifts.length === 0) {
            alert("é€™å€‹æœˆæ²’æœ‰ä»»ä½•ç­æ¬¡è¨˜éŒ„ã€‚");
            return;
          }

          // é€ä¸€åˆªé™¤
          for (const shift of allMonthlyShifts) {
            try {
              await removeShift(shift.id);
              await new Promise((resolve) => setTimeout(resolve, 100));
            } catch (error) {
              console.error("åˆªé™¤ç­æ¬¡å¤±æ•—:", shift.date, error);
            }
          }

          alert(`å·²æ¸…é™¤ ${allMonthlyShifts.length} å€‹ç­æ¬¡ï¼`);
        }
      };

      // ç®¡ç†å“¡åŠŸèƒ½ï¼šæŸ¥çœ‹æœˆåº¦çµ±è¨ˆ
      window.showMonthlyStats = function () {
        if (userRole !== "admin") {
          alert("åªæœ‰ç®¡ç†å“¡å¯ä»¥ä½¿ç”¨æ­¤åŠŸèƒ½ï¼");
          return;
        }

        const monthNames = [
          "ä¸€æœˆ",
          "äºŒæœˆ",
          "ä¸‰æœˆ",
          "å››æœˆ",
          "äº”æœˆ",
          "å…­æœˆ",
          "ä¸ƒæœˆ",
          "å…«æœˆ",
          "ä¹æœˆ",
          "åæœˆ",
          "åä¸€æœˆ",
          "åäºŒæœˆ",
        ];
        const currentMonthName =
          currentDate.getFullYear() +
          "å¹´ " +
          monthNames[currentDate.getMonth()];

        // è¨ˆç®—ç•¶æœˆçš„æ—¥æœŸç¯„åœ
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const startOfMonth = new Date(year, month, 1);
        const endOfMonth = new Date(year, month + 1, 0);

        const startDateStr = startOfMonth.toISOString().split("T")[0];
        const endDateStr = endOfMonth.toISOString().split("T")[0];

        // çµ±è¨ˆæ¯å€‹äººçš„ç­æ¬¡
        const stats = {};
        const monthlyShifts = shiftsData.filter(
          (shift) => shift.date >= startDateStr && shift.date <= endDateStr
        );

        monthlyShifts.forEach((shift) => {
          const email = shift.userEmail;
          if (!stats[email]) {
            stats[email] = 0;
          }
          stats[email]++;
        });

        // å»ºç«‹çµ±è¨ˆå ±å‘Š
        let report = `ğŸ“Š ${currentMonthName} ç­æ¬¡çµ±è¨ˆ\n\n`;

        if (Object.keys(stats).length === 0) {
          report += "é€™å€‹æœˆé‚„æ²’æœ‰ä»»ä½•ç­æ¬¡è¨˜éŒ„ã€‚";
        } else {
          Object.entries(stats)
            .sort((a, b) => b[1] - a[1]) // æŒ‰ç­æ¬¡æ•¸é‡æ’åº
            .forEach(([email, count]) => {
              const name = email.split("@")[0];
              report += `${name}: ${count} å¤©\n`;
            });

          const totalDays = Object.values(stats).reduce(
            (sum, count) => sum + count,
            0
          );
          report += `\nç¸½å…±: ${totalDays} å¤©`;
        }

        alert(report);
      };

      // å¡«æ»¿é€™é€±ï¼ˆèˆŠåŠŸèƒ½ï¼Œä¿ç•™ä»¥é˜²è¬ä¸€ï¼‰
      window.fillWeek = async function () {
        const today = new Date();
        const startOfWeek = new Date(today);
        startOfWeek.setDate(today.getDate() - today.getDay()); // é€±æ—¥ç‚ºèµ·å§‹

        await fillWeekFromDate(startOfWeek);
      };

      // æ¸…é™¤æˆ‘é€™å€‹æœˆçš„æ‰€æœ‰ç­æ¬¡
      window.clearMyMonthlyShifts = async function () {
        // åªè®€ä½¿ç”¨è€…ä¸èƒ½ä¿®æ”¹ç­è¡¨
        if (userRole === "readonly") {
          alert("æ‚¨æ˜¯åªè®€æ¬Šé™ï¼Œç„¡æ³•ä¿®æ”¹ç­è¡¨ã€‚");
          return;
        }

        const monthNames = [
          "ä¸€æœˆ",
          "äºŒæœˆ",
          "ä¸‰æœˆ",
          "å››æœˆ",
          "äº”æœˆ",
          "å…­æœˆ",
          "ä¸ƒæœˆ",
          "å…«æœˆ",
          "ä¹æœˆ",
          "åæœˆ",
          "åä¸€æœˆ",
          "åäºŒæœˆ",
        ];
        const currentMonthName =
          currentDate.getFullYear() +
          "å¹´ " +
          monthNames[currentDate.getMonth()];

        if (confirm(`ç¢ºå®šè¦æ¸…é™¤æ‚¨åœ¨ ${currentMonthName} çš„æ‰€æœ‰ç­æ¬¡å—ï¼Ÿ`)) {
          // è¨ˆç®—ç•¶æœˆçš„æ—¥æœŸç¯„åœ
          const year = currentDate.getFullYear();
          const month = currentDate.getMonth();
          const startOfMonth = new Date(year, month, 1);
          const endOfMonth = new Date(year, month + 1, 0);

          const startDateStr = startOfMonth.toISOString().split("T")[0];
          const endDateStr = endOfMonth.toISOString().split("T")[0];

          console.log(`æ¸…é™¤ ${startDateStr} åˆ° ${endDateStr} çš„ç­æ¬¡`);

          // æ‰¾å‡ºé€™å€‹æœˆæˆ‘çš„æ‰€æœ‰ç­æ¬¡
          const myMonthlyShifts = shiftsData.filter(
            (shift) =>
              shift.userId === currentUser.uid &&
              shift.date >= startDateStr &&
              shift.date <= endDateStr
          );

          console.log("æ‰¾åˆ°ç­æ¬¡æ•¸é‡:", myMonthlyShifts.length);

          if (myMonthlyShifts.length === 0) {
            alert("æ‚¨åœ¨é€™å€‹æœˆæ²’æœ‰æ’ç­è¨˜éŒ„ã€‚");
            return;
          }

          // é€ä¸€åˆªé™¤
          for (const shift of myMonthlyShifts) {
            try {
              await removeShift(shift.id);
              // åŠ å…¥å°å»¶é²é¿å…è«‹æ±‚éæ–¼é »ç¹
              await new Promise((resolve) => setTimeout(resolve, 100));
            } catch (error) {
              console.error("åˆªé™¤ç­æ¬¡å¤±æ•—:", shift.date, error);
            }
          }

          alert(`å·²æ¸…é™¤ ${myMonthlyShifts.length} å€‹ç­æ¬¡ï¼`);
        }
      };

      // åˆå§‹åŒ–
      renderCalendar();
    </script>
  </body>
</html>
