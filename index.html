<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ÊéíÁè≠Á≥ªÁµ±</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .auth-section {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .calendar-section {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .calendar {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 2px;
        margin-top: 20px;
      }

      .calendar-header {
        background: #4caf50;
        color: white;
        padding: 10px;
        text-align: center;
        font-weight: bold;
      }

      .week-button-header {
        background: #ff9800;
        color: white;
        padding: 10px;
        text-align: center;
        font-weight: bold;
        font-size: 12px;
      }

      .week-button {
        background: #fff3e0;
        border: 1px solid #ff9800;
        min-height: 80px;
        padding: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .week-button:hover {
        background: #ffe0b2;
      }

      .week-button button {
        background: #ff9800;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 11px;
        white-space: nowrap;
      }

      .week-button button:hover {
        background: #f57c00;
      }

      .calendar-day {
        background: #f9f9f9;
        border: 1px solid #ddd;
        min-height: 80px;
        padding: 5px;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .calendar-day:hover {
        background: #e8f5e8;
      }

      .calendar-day.occupied {
        background: #ffcdd2;
      }

      .calendar-day.my-shift {
        background: #c8e6c9;
      }

      .day-number {
        font-weight: bold;
        margin-bottom: 5px;
      }

      .shift-info {
        font-size: 12px;
        color: #666;
      }

      .controls {
        margin-bottom: 20px;
        text-align: center;
      }

      .controls button {
        margin: 5px;
        padding: 10px 15px;
        background: #4caf50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      .controls button:hover {
        background: #45a049;
      }

      .month-navigation {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .month-navigation button {
        padding: 10px 15px;
        background: #2196f3;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      .month-navigation button:hover {
        background: #1976d2;
      }

      .current-month {
        font-size: 18px;
        font-weight: bold;
      }

      .hidden {
        display: none;
      }

      .error {
        color: red;
        margin-top: 10px;
      }

      .success {
        color: green;
        margin-top: 10px;
      }

      input[type="email"],
      input[type="password"] {
        width: 200px;
        padding: 8px;
        margin: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      button {
        padding: 8px 15px;
        margin: 5px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      .primary-button {
        background: #4caf50;
        color: white;
      }

      .primary-button:hover {
        background: #45a049;
      }

      .secondary-button {
        background: #f44336;
        color: white;
      }

      .secondary-button:hover {
        background: #d32f2f;
      }

      /* ÁïôË®ÄÊùøÊ®£Âºè */
      .message-section {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-top: 20px;
      }

      .message-board-title {
        font-size: 18px;
        font-weight: bold;
        color: #333;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e9ecef;
      }

      .message-input-area {
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e9ecef;
      }

      .message-input {
        width: 100%;
        min-height: 80px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        resize: vertical;
        font-family: Arial, sans-serif;
        font-size: 14px;
        box-sizing: border-box;
      }

      .message-input:focus {
        outline: none;
        border-color: #4caf50;
        box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);
      }

      .message-input-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
      }

      .char-count {
        font-size: 12px;
        color: #6c757d;
      }

      .char-count.warning {
        color: #ff9800;
      }

      .char-count.danger {
        color: #f44336;
      }

      .message-submit {
        background: #28a745;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }

      .message-submit:hover {
        background: #218838;
      }

      .message-submit:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }

      .message-list {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        background: white;
      }

      .message-item {
        padding: 15px;
        border-bottom: 1px solid #e9ecef;
        transition: background-color 0.2s;
      }

      .message-item:hover {
        background-color: #f8f9fa;
      }

      .message-item:last-child {
        border-bottom: none;
      }

      .message-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .message-author {
        font-weight: bold;
        color: #495057;
      }

      .message-time {
        font-size: 12px;
        color: #6c757d;
      }

      .message-content {
        color: #343a40;
        line-height: 1.5;
        white-space: pre-wrap;
      }

      .message-actions {
        display: flex;
        gap: 5px;
        margin-left: 10px;
      }

      .message-edit-btn, .message-delete-btn {
        background: transparent;
        border: 1px solid #ddd;
        padding: 4px 8px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s;
      }

      .message-edit-btn {
        color: #007bff;
        border-color: #007bff;
      }

      .message-edit-btn:hover {
        background: #007bff;
        color: white;
      }

      .message-delete-btn {
        color: #dc3545;
        border-color: #dc3545;
      }

      .message-delete-btn:hover {
        background: #dc3545;
        color: white;
      }

      .no-messages {
        text-align: center;
        padding: 40px;
        color: #6c757d;
        font-style: italic;
      }

      .loading-messages {
        text-align: center;
        padding: 20px;
        color: #6c757d;
      }

      /* Á∑®ËºØÁïôË®ÄÊ®°ÊÖãÊ°Ü */
      .edit-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none; /* ÊîπÁÇ∫ noneÔºåËÄå‰∏çÊòØÁî® hidden class */
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      .edit-modal.show {
        display: flex; /* È°ØÁ§∫ÊôÇ‰ΩøÁî® flex */
      }

      .edit-modal-content {
        background: white;
        padding: 20px;
        border-radius: 8px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .edit-modal-header {
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 15px;
        color: #333;
      }

      .edit-modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 15px;
      }

      .edit-modal-cancel {
        background: #6c757d;
        color: white;
      }

      .edit-modal-save {
        background: #28a745;
        color: white;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>üóìÔ∏è ÊéíÁè≠Á≥ªÁµ±</h1>
      <p>ÈªûÊìäÊó•Êúü‰æÜÊñ∞Â¢ûÊàñÂà™Èô§ÊÇ®ÁöÑÁè≠Ê¨°</p>
    </div>

    <!-- ÁôªÂÖ•/Ë®ªÂÜäÂçÄÂüü -->
    <div id="auth-section" class="auth-section">
      <h3>Ë´ãÂÖàÁôªÂÖ•ÊàñË®ªÂÜä</h3>
      <div>
        <input type="email" id="email" placeholder="ÈõªÂ≠êÈÉµ‰ª∂" />
        <input type="password" id="password" placeholder="ÂØÜÁ¢º" />
      </div>
      <div>
        <button class="primary-button" onclick="signIn()">ÁôªÂÖ•</button>
        <button class="primary-button" onclick="signUp()">Ë®ªÂÜä</button>
      </div>
      <div id="auth-message"></div>
    </div>

    <!-- ‰∏ªË¶ÅÂäüËÉΩÂçÄÂüü -->
    <div id="main-section" class="calendar-section hidden">
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 20px;
        "
      >
        <div>
          <span>Ê≠°ËøéÔºå</span><span id="user-email"></span>
          <span id="role-display" style="margin-left: 10px"></span>
          <button class="secondary-button" onclick="signOut()">ÁôªÂá∫</button>
        </div>
      </div>

      <div class="controls">
        <button onclick="clearMyMonthlyShifts()">Ê∏ÖÈô§ÊàëÈÄôÂÄãÊúàÁöÑÊâÄÊúâÁè≠Ê¨°</button>
      </div>

      <div class="month-navigation">
        <button onclick="previousMonth()">¬´ ‰∏äÂÄãÊúà</button>
        <div class="current-month" id="current-month"></div>
        <button onclick="nextMonth()">‰∏ãÂÄãÊúà ¬ª</button>
      </div>

      <div class="calendar" id="calendar">
        <!-- Êó•ÊõÜÊ®ôÈ°å -->
        <div class="week-button-header">ÊéíÁè≠</div>
        <div class="calendar-header">‰∏Ä</div>
        <div class="calendar-header">‰∫å</div>
        <div class="calendar-header">‰∏â</div>
        <div class="calendar-header">Âõõ</div>
        <div class="calendar-header">‰∫î</div>
        <div class="calendar-header">ÂÖ≠</div>
        <div class="calendar-header">Êó•</div>
      </div>
    </div>

    <!-- ÁïôË®ÄÊùøÂçÄÂüü -->
    <div id="message-section" class="message-section hidden">
      <div class="message-board-title" id="message-board-title">
        üí¨ ÁïôË®ÄÊùø
      </div>
      
      <!-- Âè™ÊúâÁôªÂÖ•ÂæåÊâçÈ°ØÁ§∫Ëº∏ÂÖ•ÂçÄÂüü -->
      <div id="message-input-section" class="message-input-area hidden">
        <textarea 
          id="message-input" 
          class="message-input" 
          placeholder="Ëº∏ÂÖ•ÊÇ®ÁöÑÁïôË®Ä...Ôºà‰æãÂ¶ÇÔºöÊòéÂ§©Êúâ‰∫ãÔºåÊÉ≥ÊèõÁè≠ÁöÑÂêå‰∫ãË´ãÁßÅË®äÊàëÔºâ"
          maxlength="500"
        ></textarea>
        <div class="message-input-footer">
          <span id="char-count" class="char-count">0/500</span>
          <button id="message-submit" class="message-submit" onclick="submitMessage()">
            ÁôºË°®ÁïôË®Ä
          </button>
        </div>
      </div>
      
      <div class="message-list" id="message-list">
        <div class="no-messages">Ë´ãÂÖàÁôªÂÖ•‰ª•Êü•ÁúãÁïôË®Ä</div>
      </div>
    </div>

    <!-- Á∑®ËºØÁïôË®ÄÊ®°ÊÖãÊ°Ü - Á¢∫‰øùÂàùÂßãÁãÄÊÖãÊòØÈö±ËóèÁöÑ -->
    <div id="edit-modal" class="edit-modal">
      <div class="edit-modal-content">
        <div class="edit-modal-header">Á∑®ËºØÁïôË®Ä</div>
        <textarea 
          id="edit-message-input" 
          class="message-input" 
          maxlength="500"
        ></textarea>
        <div class="message-input-footer">
          <span id="edit-char-count" class="char-count">0/500</span>
        </div>
        <div class="edit-modal-footer">
          <button class="edit-modal-cancel" onclick="cancelEdit()">ÂèñÊ∂à</button>
          <button class="edit-modal-save" onclick="saveEdit()">ÂÑ≤Â≠ò</button>
        </div>
      </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
      // TODO: Ë´ãÂ∞á‰∏ãÈù¢ÁöÑ firebaseConfig ÊõøÊèõÊàêÊÇ®Âæû Firebase ÊéßÂà∂Âè∞ÂèñÂæóÁöÑÈÖçÁΩÆ
      const firebaseConfig = {
            apiKey: "AIzaSyDcX1hjA9_qyb6kYgYbQaRblwFrXdW-hWo",
            authDomain: "mchplainfilmschedule.firebaseapp.com",
            projectId: "mchplainfilmschedule",
            storageBucket: "mchplainfilmschedule.firebasestorage.app",
            messagingSenderId: "104675634969",
            appId: "1:104675634969:web:3816e35be9d4a551415f88",
            measurementId: "G-5T31DSRENK"
        };

      // Â∞éÂÖ• Firebase ÂäüËÉΩ
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getAuth,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut as firebaseSignOut,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        addDoc,
        query,
        where,
        getDocs,
        deleteDoc,
        doc,
        orderBy,
        updateDoc,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      // ÂàùÂßãÂåñ Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // ÂÖ®ÂüüËÆäÊï∏
      let currentDate = new Date();
      let currentUser = null;
      let shiftsData = [];
      let messagesData = [];
      let userRole = "normal";
      let editingMessageId = null;

      // Ê¨äÈôêË®≠ÂÆö
      const ADMIN_EMAILS = [
        "hw98188@gmail.com",
        // Âú®ÈÄôË£°Âä†ÂÖ•ÁÆ°ÁêÜÂì° email
      ];

      const READONLY_EMAILS = [
        "readonly@company.com",
        "guest@company.com",
        // Âú®ÈÄôË£°Âä†ÂÖ•Âè™ËÆÄÊ¨äÈôêÁöÑ email
      ];

      // Ê™¢Êü•‰ΩøÁî®ËÄÖÊ¨äÈôê
      function getUserRole(email) {
        if (ADMIN_EMAILS.includes(email)) {
          return "admin";
        } else if (READONLY_EMAILS.includes(email)) {
          return "readonly";
        } else {
          return "normal";
        }
      }

      // Áõ£ËÅΩË™çË≠âÁãÄÊÖãËÆäÂåñ
      onAuthStateChanged(auth, (user) => {
        if (user) {
          currentUser = user;
          userRole = getUserRole(user.email);

          // È°ØÁ§∫‰∏ªË¶ÅÂçÄÂüü
          document.getElementById("auth-section").classList.add("hidden");
          document.getElementById("main-section").classList.remove("hidden");
          document.getElementById("message-section").classList.remove("hidden");
          
          // È°ØÁ§∫ÁïôË®ÄËº∏ÂÖ•ÂçÄÂüü
          const messageInputSection = document.getElementById("message-input-section");
          if (messageInputSection) {
            messageInputSection.classList.remove("hidden");
          }

          updateUserInterface();
          loadShifts();
          loadMessages();
        } else {
          currentUser = null;
          userRole = "normal";
          
          // Èö±Ëóè‰∏ªË¶ÅÂçÄÂüü
          document.getElementById("auth-section").classList.remove("hidden");
          document.getElementById("main-section").classList.add("hidden");
          document.getElementById("message-section").classList.add("hidden");
          
          // Èö±ËóèÁïôË®ÄËº∏ÂÖ•ÂçÄÂüü
          const messageInputSection = document.getElementById("message-input-section");
          if (messageInputSection) {
            messageInputSection.classList.add("hidden");
          }
          
          // Ê∏ÖÁ©∫ÁïôË®ÄË≥áÊñôÂíåÈ°ØÁ§∫
          messagesData = [];
          const messageList = document.getElementById("message-list");
          if (messageList) {
            messageList.innerHTML = '<div class="no-messages">Ë´ãÂÖàÁôªÂÖ•‰ª•Êü•ÁúãÁïôË®Ä</div>';
          }
        }
      });

      // Êõ¥Êñ∞‰ΩøÁî®ËÄÖ‰ªãÈù¢
      function updateUserInterface() {
        const userEmail = document.getElementById("user-email");
        const roleDisplay = document.getElementById("role-display");

        let roleText = "";
        let roleColor = "";

        switch (userRole) {
          case "admin":
            roleText = "üëë ÁÆ°ÁêÜÂì°";
            roleColor = "#ff6b6b";
            break;
          case "readonly":
            roleText = "üëÅÔ∏è Âè™ËÆÄÊ¨äÈôê";
            roleColor = "#74b9ff";
            break;
          default:
            roleText = "üë§ ‰∏ÄËà¨‰ΩøÁî®ËÄÖ";
            roleColor = "#00b894";
        }

        userEmail.textContent = currentUser.email;
        roleDisplay.textContent = roleText;
        roleDisplay.style.color = roleColor;
        roleDisplay.style.fontWeight = "bold";

        updateControlsVisibility();
        updateMessageBoardTitle();
      }

      // Ê†πÊìöÊ¨äÈôêÊõ¥Êñ∞ÊéßÂà∂ÊåâÈàï
      function updateControlsVisibility() {
        const controls = document.querySelector(".controls");

        if (userRole === "readonly") {
          controls.style.display = "none";
        } else {
          controls.style.display = "block";

          if (userRole === "admin") {
            addAdminControls();
          }
        }
      }

      // Êñ∞Â¢ûÁÆ°ÁêÜÂì°Â∞àÁî®ÊéßÂà∂ÊåâÈàï
      function addAdminControls() {
        const controls = document.querySelector(".controls");

        if (!document.getElementById("admin-controls")) {
          const adminDiv = document.createElement("div");
          adminDiv.id = "admin-controls";
          adminDiv.style.marginTop = "10px";
          adminDiv.style.padding = "10px";
          adminDiv.style.backgroundColor = "#fff5f5";
          adminDiv.style.border = "2px solid #ff6b6b";
          adminDiv.style.borderRadius = "5px";

          adminDiv.innerHTML = `
            <div style="color: #ff6b6b; font-weight: bold; margin-bottom: 10px;">üëë ÁÆ°ÁêÜÂì°ÂäüËÉΩ</div>
            <button onclick="clearAllMonthlyShifts()" style="background: #ff6b6b; margin: 5px;">Ê∏ÖÈô§ÊâÄÊúâ‰∫∫ÈÄôÂÄãÊúàÁöÑÁè≠Ê¨°</button>
            <button onclick="showMonthlyStats()" style="background: #0984e3; margin: 5px;">Êü•ÁúãÊúàÂ∫¶Áµ±Ë®à</button>
          `;

          controls.appendChild(adminDiv);
        }
      }

      // Ë®ªÂÜäÂäüËÉΩ
      window.signUp = async function () {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const messageDiv = document.getElementById("auth-message");

        try {
          await createUserWithEmailAndPassword(auth, email, password);
          messageDiv.innerHTML = '<div class="success">Ë®ªÂÜäÊàêÂäüÔºÅ</div>';
        } catch (error) {
          messageDiv.innerHTML =
            '<div class="error">Ë®ªÂÜäÂ§±ÊïóÔºö' + error.message + "</div>";
        }
      };

      // ÁôªÂÖ•ÂäüËÉΩ
      window.signIn = async function () {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const messageDiv = document.getElementById("auth-message");

        try {
          await signInWithEmailAndPassword(auth, email, password);
          messageDiv.innerHTML = '<div class="success">ÁôªÂÖ•ÊàêÂäüÔºÅ</div>';
        } catch (error) {
          messageDiv.innerHTML =
            '<div class="error">ÁôªÂÖ•Â§±ÊïóÔºö' + error.message + "</div>";
        }
      };

      // ÁôªÂá∫ÂäüËÉΩ
      window.signOut = async function () {
        try {
          await firebaseSignOut(auth);
        } catch (error) {
          console.error("ÁôªÂá∫Â§±ÊïóÔºö", error);
        }
      };

      // ËºâÂÖ•Áè≠Ë°®Êï∏Êìö
      async function loadShifts() {
        try {
          const shiftsRef = collection(db, "shifts");
          const q = query(shiftsRef, orderBy("date"));
          const querySnapshot = await getDocs(q);

          shiftsData = [];
          querySnapshot.forEach((doc) => {
            shiftsData.push({ id: doc.id, ...doc.data() });
          });

          renderCalendar();
        } catch (error) {
          console.error("ËºâÂÖ•Áè≠Ë°®Â§±ÊïóÔºö", error);
        }
      }

      // Êñ∞Â¢ûÁè≠Ê¨°
      async function addShift(dateStr) {
        try {
          await addDoc(collection(db, "shifts"), {
            date: dateStr,
            userId: currentUser.uid,
            userEmail: currentUser.email,
            timestamp: new Date(),
          });
          loadShifts();
        } catch (error) {
          console.error("Êñ∞Â¢ûÁè≠Ê¨°Â§±ÊïóÔºö", error);
          alert("Êñ∞Â¢ûÁè≠Ê¨°Â§±ÊïóÔºö" + error.message);
        }
      }

      // Âà™Èô§Áè≠Ê¨°
      async function removeShift(shiftId) {
        try {
          await deleteDoc(doc(db, "shifts", shiftId));
          loadShifts();
        } catch (error) {
          console.error("Âà™Èô§Áè≠Ê¨°Â§±ÊïóÔºö", error);
          alert("Âà™Èô§Áè≠Ê¨°Â§±ÊïóÔºö" + error.message);
        }
      }

      // ========== ÁïôË®ÄÊùøÂäüËÉΩ ==========

      // Êõ¥Êñ∞ÁïôË®ÄÊùøÊ®ôÈ°å
      function updateMessageBoardTitle() {
        const monthNames = ['‰∏ÄÊúà', '‰∫åÊúà', '‰∏âÊúà', 'ÂõõÊúà', '‰∫îÊúà', 'ÂÖ≠Êúà', '‰∏ÉÊúà', 'ÂÖ´Êúà', '‰πùÊúà', 'ÂçÅÊúà', 'ÂçÅ‰∏ÄÊúà', 'ÂçÅ‰∫åÊúà'];
        const currentMonthName = `${currentDate.getFullYear()}Âπ¥ ${monthNames[currentDate.getMonth()]}`;
        const titleElement = document.getElementById("message-board-title");
        if (titleElement) {
          titleElement.textContent = `üí¨ ${currentMonthName} ÁïôË®ÄÊùø`;
        }
      }

      // ËºâÂÖ•ÁïôË®Ä
      async function loadMessages() {
        try {
          const messageList = document.getElementById("message-list");
          messageList.innerHTML = '<div class="loading-messages">ËºâÂÖ•ÁïôË®Ä‰∏≠...</div>';

          const monthKey = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
          console.log('ËºâÂÖ•ÁïôË®ÄÔºåÊúà‰ªΩ:', monthKey);

          const messagesRef = collection(db, "messages");
          const q = query(messagesRef, where("monthKey", "==", monthKey));
          const querySnapshot = await getDocs(q);

          messagesData = [];
          querySnapshot.forEach((doc) => {
            messagesData.push({ id: doc.id, ...doc.data() });
          });

          // ÊåâÊôÇÈñìÊéíÂ∫èÔºàÊúÄÊñ∞ÁöÑÂú®ÂâçÈù¢Ôºâ
          messagesData.sort((a, b) => {
            const timeA = a.timestamp?.seconds || a.timestamp?.getTime() / 1000 || 0;
            const timeB = b.timestamp?.seconds || b.timestamp?.getTime() / 1000 || 0;
            return timeB - timeA;
          });

          console.log(`ËºâÂÖ• ${monthKey} ÁöÑÁïôË®ÄÊï∏Èáè:`, messagesData.length);
          renderMessages();
        } catch (error) {
          console.error("ËºâÂÖ•ÁïôË®ÄÂ§±ÊïóÔºö", error);
          messagesData = [];
          renderMessages();
        }
      }

      // Ê∏≤ÊüìÁïôË®ÄÂàóË°®
      function renderMessages() {
        const messageList = document.getElementById("message-list");
        
        // Â¶ÇÊûúÊú™ÁôªÂÖ•Ôºå‰∏çÈ°ØÁ§∫‰ªª‰ΩïÂÖßÂÆπ
        if (!currentUser) {
          messageList.innerHTML = '<div class="no-messages">Ë´ãÂÖàÁôªÂÖ•‰ª•Êü•ÁúãÁïôË®Ä</div>';
          return;
        }

        if (messagesData.length === 0) {
          messageList.innerHTML = '<div class="no-messages">Êú¨ÊúàÈÇÑÊ≤íÊúâÁïôË®ÄÔºåÊàêÁÇ∫Á¨¨‰∏ÄÂÄãÁïôË®ÄÁöÑ‰∫∫ÂêßÔºÅ</div>';
          return;
        }

        let html = '';
        messagesData.forEach(message => {
          // ËôïÁêÜÊôÇÈñìÊà≥Ë®ò - ÂÑ™ÂÖàÈ°ØÁ§∫Á∑®ËºØÊôÇÈñì
          let displayDate;
          let timeLabel = '';
          
          if (message.editedAt) {
            // Â¶ÇÊûúÊúâÁ∑®ËºØÊôÇÈñìÔºåÈ°ØÁ§∫Á∑®ËºØÊôÇÈñì
            if (message.editedAt?.seconds) {
              displayDate = new Date(message.editedAt.seconds * 1000);
            } else if (message.editedAt?.getTime) {
              displayDate = message.editedAt;
            } else {
              displayDate = new Date();
            }
            timeLabel = '(Â∑≤Á∑®ËºØ)';
          } else {
            // Ê≤íÊúâÁ∑®ËºØÊôÇÈñìÔºåÈ°ØÁ§∫ÂéüÂßãÁôºË°®ÊôÇÈñì
            if (message.timestamp?.seconds) {
              displayDate = new Date(message.timestamp.seconds * 1000);
            } else if (message.timestamp?.getTime) {
              displayDate = message.timestamp;
            } else {
              displayDate = new Date();
            }
          }

          const formattedTime = displayDate.toLocaleString('zh-TW', {
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
          });

          const userName = message.userEmail.split('@')[0];
          const canEdit = userRole === 'admin' || message.userId === currentUser.uid;

          html += `
            <div class="message-item">
              <div class="message-header">
                <span class="message-author">[${formattedTime}${timeLabel}] ${userName}Ôºö</span>
                ${canEdit ? `
                  <div class="message-actions">
                    <button class="message-edit-btn" onclick="editMessage('${message.id}')">Á∑®ËºØ</button>
                    <button class="message-delete-btn" onclick="deleteMessage('${message.id}')">Âà™Èô§</button>
                  </div>
                ` : ''}
              </div>
              <div class="message-content">${message.content}</div>
            </div>
          `;
        });

        messageList.innerHTML = html;
      }

      // ÁôºË°®ÁïôË®Ä
      window.submitMessage = async function() {
        // Ê™¢Êü•ÊòØÂê¶Â∑≤ÁôªÂÖ•
        if (!currentUser) {
          alert('Ë´ãÂÖàÁôªÂÖ•ÊâçËÉΩÁôºË°®ÁïôË®ÄÔºÅ');
          return;
        }
        
        const messageInput = document.getElementById("message-input");
        const submitButton = document.getElementById("message-submit");
        
        const content = messageInput.value.trim();
        
        if (!content) {
          alert('Ë´ãËº∏ÂÖ•ÁïôË®ÄÂÖßÂÆπÔºÅ');
          return;
        }
        
        if (content.length > 500) {
          alert('ÁïôË®ÄÂÖßÂÆπ‰∏çËÉΩË∂ÖÈÅé500Â≠óÔºÅ');
          return;
        }
        
        submitButton.disabled = true;
        submitButton.textContent = 'ÁôºË°®‰∏≠...';
        
        try {
          const monthKey = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
          
          await addDoc(collection(db, "messages"), {
            content: content,
            userId: currentUser.uid,
            userEmail: currentUser.email,
            monthKey: monthKey,
            timestamp: new Date()
          });
          
          messageInput.value = '';
          updateCharCount();
          
          console.log('ÁïôË®ÄÁôºË°®ÊàêÂäü');
          setTimeout(loadMessages, 300);
          
        } catch (error) {
          console.error('ÁôºË°®ÁïôË®ÄÂ§±ÊïóÔºö', error);
          alert('ÁôºË°®ÁïôË®ÄÂ§±ÊïóÔºö' + error.message);
        } finally {
          submitButton.disabled = false;
          submitButton.textContent = 'ÁôºË°®ÁïôË®Ä';
        }
      };

      // Á∑®ËºØÁïôË®Ä - Âä†ÂÖ•Êõ¥Â§öÂÆâÂÖ®Ê™¢Êü•
      window.editMessage = function(messageId) {
        console.log('editMessage Ë¢´ÂëºÂè´ÔºåmessageId:', messageId, 'currentUser:', currentUser);
        
        if (!currentUser) {
          console.log('‰ΩøÁî®ËÄÖÊú™ÁôªÂÖ•ÔºåÁÑ°Ê≥ïÁ∑®ËºØÁïôË®Ä');
          alert('Ë´ãÂÖàÁôªÂÖ•ÊâçËÉΩÁ∑®ËºØÁïôË®ÄÔºÅ');
          return;
        }
        
        if (!messageId) {
          console.log('messageId ÁÑ°Êïà');
          return;
        }
        
        const message = messagesData.find(m => m.id === messageId);
        if (!message) {
          console.log('Êâæ‰∏çÂà∞Â∞çÊáâÁöÑÁïôË®Ä');
          return;
        }

        // Ê™¢Êü•Ê¨äÈôê
        if (userRole !== 'admin' && message.userId !== currentUser.uid) {
          alert('ÊÇ®Âè™ËÉΩÁ∑®ËºØËá™Â∑±ÁöÑÁïôË®ÄÔºÅ');
          return;
        }

        editingMessageId = messageId;
        const editInput = document.getElementById("edit-message-input");
        const modal = document.getElementById("edit-modal");
        
        if (editInput && modal) {
          editInput.value = message.content;
          updateEditCharCount();
          modal.classList.add("show");
        }
      };

      // ÂèñÊ∂àÁ∑®ËºØ
      window.cancelEdit = function() {
        editingMessageId = null;
        const modal = document.getElementById("edit-modal");
        if (modal) {
          modal.classList.remove("show");
        }
      };

      // ÂÑ≤Â≠òÁ∑®ËºØ
      window.saveEdit = async function() {
        if (!editingMessageId) return;

        const editInput = document.getElementById("edit-message-input");
        const content = editInput.value.trim();

        if (!content) {
          alert('Ë´ãËº∏ÂÖ•ÁïôË®ÄÂÖßÂÆπÔºÅ');
          return;
        }

        if (content.length > 500) {
          alert('ÁïôË®ÄÂÖßÂÆπ‰∏çËÉΩË∂ÖÈÅé500Â≠óÔºÅ');
          return;
        }

        try {
          await updateDoc(doc(db, "messages", editingMessageId), {
            content: content,
            editedAt: new Date()
          });

          console.log('ÁïôË®ÄÁ∑®ËºØÊàêÂäü');
          cancelEdit();
          setTimeout(loadMessages, 300);

        } catch (error) {
          console.error('Á∑®ËºØÁïôË®ÄÂ§±ÊïóÔºö', error);
          alert('Á∑®ËºØÁïôË®ÄÂ§±ÊïóÔºö' + error.message);
        }
      };

      // Âà™Èô§ÁïôË®Ä - Âä†ÂÖ•Êõ¥Â§öÂÆâÂÖ®Ê™¢Êü•
      window.deleteMessage = async function(messageId) {
        console.log('deleteMessage Ë¢´ÂëºÂè´ÔºåmessageId:', messageId, 'currentUser:', currentUser);
        
        if (!currentUser) {
          console.log('‰ΩøÁî®ËÄÖÊú™ÁôªÂÖ•ÔºåÁÑ°Ê≥ïÂà™Èô§ÁïôË®Ä');
          alert('Ë´ãÂÖàÁôªÂÖ•ÊâçËÉΩÂà™Èô§ÁïôË®ÄÔºÅ');
          return;
        }
        
        if (!messageId) {
          console.log('messageId ÁÑ°Êïà');
          return;
        }
        
        const message = messagesData.find(m => m.id === messageId);
        if (!message) {
          console.log('Êâæ‰∏çÂà∞Â∞çÊáâÁöÑÁïôË®Ä');
          return;
        }

        // Ê™¢Êü•Ê¨äÈôê
        if (userRole !== 'admin' && message.userId !== currentUser.uid) {
          alert('ÊÇ®Âè™ËÉΩÂà™Èô§Ëá™Â∑±ÁöÑÁïôË®ÄÔºÅ');
          return;
        }

        const userName = message.userEmail.split('@')[0];
        if (confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§ ${userName} ÁöÑÁïôË®ÄÂóéÔºü`)) {
          try {
            await deleteDoc(doc(db, "messages", messageId));
            console.log('ÁïôË®ÄÂà™Èô§ÊàêÂäü');
            setTimeout(loadMessages, 300);
          } catch (error) {
            console.error('Âà™Èô§ÁïôË®ÄÂ§±ÊïóÔºö', error);
            alert('Âà™Èô§ÁïôË®ÄÂ§±ÊïóÔºö' + error.message);
          }
        }
      };

      // Êõ¥Êñ∞Â≠óÊï∏Ë®àÊï∏
      function updateCharCount() {
        const input = document.getElementById("message-input");
        const counter = document.getElementById("char-count");
        const length = input.value.length;
        
        counter.textContent = `${length}/500`;
        
        counter.className = "char-count";
        if (length > 450) {
          counter.classList.add("danger");
        } else if (length > 400) {
          counter.classList.add("warning");
        }
      }

      // Êõ¥Êñ∞Á∑®ËºØÊ®°ÊÖãÊ°ÜÂ≠óÊï∏Ë®àÊï∏
      function updateEditCharCount() {
        const input = document.getElementById("edit-message-input");
        const counter = document.getElementById("edit-char-count");
        const length = input.value.length;
        
        counter.textContent = `${length}/500`;
        
        counter.className = "char-count";
        if (length > 450) {
          counter.classList.add("danger");
        } else if (length > 400) {
          counter.classList.add("warning");
        }
      }

      // Á∂ÅÂÆöËº∏ÂÖ•‰∫ã‰ª∂
      document.addEventListener('DOMContentLoaded', function() {
        const messageInput = document.getElementById("message-input");
        const editInput = document.getElementById("edit-message-input");
        
        if (messageInput) {
          messageInput.addEventListener('input', updateCharCount);
        }
        
        if (editInput) {
          editInput.addEventListener('input', updateEditCharCount);
        }
      });

      // Ê∏≤ÊüìÊó•ÊõÜ
      function renderCalendar() {
        const calendar = document.getElementById("calendar");
        const monthNames = [
          "‰∏ÄÊúà",
          "‰∫åÊúà",
          "‰∏âÊúà",
          "ÂõõÊúà",
          "‰∫îÊúà",
          "ÂÖ≠Êúà",
          "‰∏ÉÊúà",
          "ÂÖ´Êúà",
          "‰πùÊúà",
          "ÂçÅÊúà",
          "ÂçÅ‰∏ÄÊúà",
          "ÂçÅ‰∫åÊúà",
        ];

        // Êõ¥Êñ∞Êúà‰ªΩÊ®ôÈ°å
        document.getElementById("current-month").textContent =
          currentDate.getFullYear() +
          "Âπ¥ " +
          monthNames[currentDate.getMonth()];

        // Êõ¥Êñ∞ÁïôË®ÄÊùøÊ®ôÈ°å
        updateMessageBoardTitle();

        // Ê∏ÖÈô§ÁèæÊúâÁöÑÊó•ÊúüÔºà‰øùÁïôÊ®ôÈ°åÔºâ
        const existingElements = calendar.querySelectorAll(
          ".calendar-day, .week-button"
        );
        existingElements.forEach((element) => element.remove());

        // Ë®àÁÆóÊúà‰ªΩÁöÑÁ¨¨‰∏ÄÂ§©
        const firstDay = new Date(
          currentDate.getFullYear(),
          currentDate.getMonth(),
          1
        );

        // ÊâæÂà∞ÈÄôÂÄãÊúàÁ¨¨‰∏ÄÂÄãÈÄ±‰∏Ä
        const startDate = new Date(firstDay);
        const dayOfWeek = firstDay.getDay(); // 0=ÈÄ±Êó•, 1=ÈÄ±‰∏Ä, ..., 6=ÈÄ±ÂÖ≠
        const daysToSubtract = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // ÈÄ±Êó•ÁöÑË©±Ë¶ÅÊ∏õ6Â§©ÊâçÂà∞ÈÄ±‰∏Ä
        startDate.setDate(firstDay.getDate() - daysToSubtract);

        // ÁîüÊàê6ÈÄ±ÁöÑÊó•ÊõÜ
        for (let week = 0; week < 6; week++) {
          // ÂâµÂª∫ÈÄ±ÁöÑÈñãÂßãÊó•ÊúüÔºàÈÄ±‰∏ÄÔºâ
          const weekStartDate = new Date(startDate);
          weekStartDate.setDate(startDate.getDate() + week * 7);

          // Ê∑ªÂä†ÈÄ±ÊåâÈàï
          const weekButton = document.createElement("div");
          weekButton.className = "week-button";

          const button = document.createElement("button");
          button.textContent = "Â°´ÊªøÊï¥ÈÄ±";
          button.onclick = () => fillWeekFromDate(weekStartDate);

          weekButton.appendChild(button);
          calendar.appendChild(weekButton);

          // Ê∑ªÂä†ÈÄôÈÄ±ÁöÑ7Â§©ÔºàÈÄ±‰∏ÄÂà∞ÈÄ±Êó•Ôºâ
          for (let day = 0; day < 7; day++) {
            const date = new Date(weekStartDate);
            date.setDate(weekStartDate.getDate() + day);

            const dayElement = document.createElement("div");
            dayElement.className = "calendar-day";

            const dayNumber = document.createElement("div");
            dayNumber.className = "day-number";
            dayNumber.textContent = date.getDate();

            const shiftInfo = document.createElement("div");
            shiftInfo.className = "shift-info";

            // Ê™¢Êü•ÈÄô‰∏ÄÂ§©ÊòØÂê¶ÊúâÁè≠Ê¨°
            const dateStr = date.toISOString().split("T")[0];
            const dayShift = shiftsData.find((shift) => shift.date === dateStr);

            if (dayShift) {
              shiftInfo.textContent = dayShift.userEmail.split("@")[0];
              if (dayShift.userId === currentUser.uid) {
                dayElement.classList.add("my-shift");
              } else {
                dayElement.classList.add("occupied");
              }
            }

            // Â¶ÇÊûú‰∏çÊòØÁï∂ÂâçÊúà‰ªΩÔºåË®≠ÁÇ∫ÁÅ∞Ëâ≤
            if (date.getMonth() !== currentDate.getMonth()) {
              dayElement.style.opacity = "0.3";
            }

            // ÈÄ±Êú´ÔºàÈÄ±ÂÖ≠„ÄÅÈÄ±Êó•ÔºâÂèØ‰ª•Áî®‰∏çÂêåÈ°èËâ≤ÂçÄÂà•
            if (day === 5 || day === 6) {
              // ÈÄ±ÂÖ≠„ÄÅÈÄ±Êó•
              dayElement.style.backgroundColor = "#f0f8ff";
            }

            // ÈªûÊìä‰∫ã‰ª∂
            dayElement.addEventListener("click", () =>
              handleDayClick(dateStr, dayShift)
            );

            dayElement.appendChild(dayNumber);
            dayElement.appendChild(shiftInfo);
            calendar.appendChild(dayElement);
          }
        }
      }

      // ËôïÁêÜÊó•ÊúüÈªûÊìä
      function handleDayClick(dateStr, existingShift) {
        // Âè™ËÆÄ‰ΩøÁî®ËÄÖ‰∏çËÉΩ‰øÆÊîπÁè≠Ë°®
        if (userRole === "readonly") {
          alert("ÊÇ®ÊòØÂè™ËÆÄÊ¨äÈôêÔºåÁÑ°Ê≥ï‰øÆÊîπÁè≠Ë°®„ÄÇ");
          return;
        }

        if (existingShift) {
          // ÁÆ°ÁêÜÂì°ÂèØ‰ª•Âà™Èô§‰ªª‰Ωï‰∫∫ÁöÑÁè≠Ê¨°
          if (userRole === "admin") {
            const userName = existingShift.userEmail.split("@")[0];
            if (confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§ ${userName} Âú®ÈÄôÂ§©ÁöÑÁè≠Ê¨°ÂóéÔºü`)) {
              removeShift(existingShift.id);
            }
          } else if (existingShift.userId === currentUser.uid) {
            // ‰∏ÄËà¨‰ΩøÁî®ËÄÖÂè™ËÉΩÂà™Èô§Ëá™Â∑±ÁöÑÁè≠Ê¨°
            if (confirm("Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂÄãÁè≠Ê¨°ÂóéÔºü")) {
              removeShift(existingShift.id);
            }
          } else {
            alert("ÈÄôÂ§©Â∑≤Á∂ìÊúâÂÖ∂‰ªñ‰∫∫ÊéíÁè≠‰∫ÜÔºÅ");
          }
        } else {
          // Êñ∞Â¢ûÁè≠Ê¨°
          addShift(dateStr);
        }
      }

      // ‰∏äÂÄãÊúà
      window.previousMonth = function () {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
        loadMessages(); // ËºâÂÖ•Êñ∞Êúà‰ªΩÁöÑÁïôË®Ä
      };

      // ‰∏ãÂÄãÊúà
      window.nextMonth = function () {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
        loadMessages(); // ËºâÂÖ•Êñ∞Êúà‰ªΩÁöÑÁïôË®Ä
      };

      // Â°´ÊªøÊåáÂÆöÈÄ±
      async function fillWeekFromDate(startDate) {
        // Âè™ËÆÄ‰ΩøÁî®ËÄÖ‰∏çËÉΩ‰øÆÊîπÁè≠Ë°®
        if (userRole === "readonly") {
          alert("ÊÇ®ÊòØÂè™ËÆÄÊ¨äÈôêÔºåÁÑ°Ê≥ï‰øÆÊîπÁè≠Ë°®„ÄÇ");
          return;
        }

        console.log("ÈñãÂßãÂ°´ÊªøÈÄ±:", startDate); // Èô§ÈåØÁî®

        for (let i = 0; i < 7; i++) {
          const date = new Date(startDate);
          date.setDate(startDate.getDate() + i);
          const dateStr = date.toISOString().split("T")[0];

          console.log("Ê™¢Êü•Êó•Êúü:", dateStr); // Èô§ÈåØÁî®

          // Ê™¢Êü•ÈÄôÂ§©ÊòØÂê¶Â∑≤Á∂ìÊúâ‰∫∫ÊéíÁè≠
          const existingShift = shiftsData.find(
            (shift) => shift.date === dateStr
          );
          if (!existingShift) {
            console.log("Êñ∞Â¢ûÁè≠Ê¨°:", dateStr); // Èô§ÈåØÁî®
            try {
              await addShift(dateStr);
              // Âä†ÂÖ•Â∞èÂª∂ÈÅ≤ÔºåÈÅøÂÖçÂêåÊôÇÁôºÈÄÅÂ§™Â§öË´ãÊ±Ç
              await new Promise((resolve) => setTimeout(resolve, 100));
            } catch (error) {
              console.error("Êñ∞Â¢ûÁè≠Ê¨°Â§±Êïó:", dateStr, error);
            }
          } else {
            console.log("Â∑≤Êúâ‰∫∫ÊéíÁè≠:", dateStr, existingShift.userEmail); // Èô§ÈåØÁî®
          }
        }

        alert("Â°´ÊªøÊï¥ÈÄ±ÂÆåÊàêÔºÅ");
      }

      // ÁÆ°ÁêÜÂì°ÂäüËÉΩÔºöÊ∏ÖÈô§ÊâÄÊúâ‰∫∫ÈÄôÂÄãÊúàÁöÑÁè≠Ê¨°
      window.clearAllMonthlyShifts = async function () {
        if (userRole !== "admin") {
          alert("Âè™ÊúâÁÆ°ÁêÜÂì°ÂèØ‰ª•‰ΩøÁî®Ê≠§ÂäüËÉΩÔºÅ");
          return;
        }

        const monthNames = [
          "‰∏ÄÊúà",
          "‰∫åÊúà",
          "‰∏âÊúà",
          "ÂõõÊúà",
          "‰∫îÊúà",
          "ÂÖ≠Êúà",
          "‰∏ÉÊúà",
          "ÂÖ´Êúà",
          "‰πùÊúà",
          "ÂçÅÊúà",
          "ÂçÅ‰∏ÄÊúà",
          "ÂçÅ‰∫åÊúà",
        ];
        const currentMonthName =
          currentDate.getFullYear() +
          "Âπ¥ " +
          monthNames[currentDate.getMonth()];

        if (
          confirm(
            `‚ö†Ô∏è ÁÆ°ÁêÜÂì°Ê¨äÈôê ‚ö†Ô∏è\n\nÁ¢∫ÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâ‰∫∫Âú® ${currentMonthName} ÁöÑÁè≠Ê¨°ÂóéÔºü\n\nÈÄôÂÄãÂãï‰ΩúÁÑ°Ê≥ïÂæ©ÂéüÔºÅ`
          )
        ) {
          // Ë®àÁÆóÁï∂ÊúàÁöÑÊó•ÊúüÁØÑÂúç
          const year = currentDate.getFullYear();
          const month = currentDate.getMonth();
          const startOfMonth = new Date(year, month, 1);
          const endOfMonth = new Date(year, month + 1, 0);

          const startDateStr = startOfMonth.toISOString().split("T")[0];
          const endDateStr = endOfMonth.toISOString().split("T")[0];

          // ÊâæÂá∫ÈÄôÂÄãÊúàÊâÄÊúâ‰∫∫ÁöÑÁè≠Ê¨°
          const allMonthlyShifts = shiftsData.filter(
            (shift) => shift.date >= startDateStr && shift.date <= endDateStr
          );

          if (allMonthlyShifts.length === 0) {
            alert("ÈÄôÂÄãÊúàÊ≤íÊúâ‰ªª‰ΩïÁè≠Ê¨°Ë®òÈåÑ„ÄÇ");
            return;
          }

          // ÈÄê‰∏ÄÂà™Èô§
          for (const shift of allMonthlyShifts) {
            try {
              await removeShift(shift.id);
              await new Promise((resolve) => setTimeout(resolve, 100));
            } catch (error) {
              console.error("Âà™Èô§Áè≠Ê¨°Â§±Êïó:", shift.date, error);
            }
          }

          alert(`Â∑≤Ê∏ÖÈô§ ${allMonthlyShifts.length} ÂÄãÁè≠Ê¨°ÔºÅ`);
        }
      };

      // ÁÆ°ÁêÜÂì°ÂäüËÉΩÔºöÊü•ÁúãÊúàÂ∫¶Áµ±Ë®à
      window.showMonthlyStats = function () {
        if (userRole !== "admin") {
          alert("Âè™ÊúâÁÆ°ÁêÜÂì°ÂèØ‰ª•‰ΩøÁî®Ê≠§ÂäüËÉΩÔºÅ");
          return;
        }

        const monthNames = [
          "‰∏ÄÊúà",
          "‰∫åÊúà",
          "‰∏âÊúà",
          "ÂõõÊúà",
          "‰∫îÊúà",
          "ÂÖ≠Êúà",
          "‰∏ÉÊúà",
          "ÂÖ´Êúà",
          "‰πùÊúà",
          "ÂçÅÊúà",
          "ÂçÅ‰∏ÄÊúà",
          "ÂçÅ‰∫åÊúà",
        ];
        const currentMonthName =
          currentDate.getFullYear() +
          "Âπ¥ " +
          monthNames[currentDate.getMonth()];

        // Ë®àÁÆóÁï∂ÊúàÁöÑÊó•ÊúüÁØÑÂúç
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const startOfMonth = new Date(year, month, 1);
        const endOfMonth = new Date(year, month + 1, 0);

        const startDateStr = startOfMonth.toISOString().split("T")[0];
        const endDateStr = endOfMonth.toISOString().split("T")[0];

        // Áµ±Ë®àÊØèÂÄã‰∫∫ÁöÑÁè≠Ê¨°
        const stats = {};
        const monthlyShifts = shiftsData.filter(
          (shift) => shift.date >= startDateStr && shift.date <= endDateStr
        );

        monthlyShifts.forEach((shift) => {
          const email = shift.userEmail;
          if (!stats[email]) {
            stats[email] = 0;
          }
          stats[email]++;
        });

        // Âª∫Á´ãÁµ±Ë®àÂ†±Âëä
        let report = `üìä ${currentMonthName} Áè≠Ê¨°Áµ±Ë®à\n\n`;

        if (Object.keys(stats).length === 0) {
          report += "ÈÄôÂÄãÊúàÈÇÑÊ≤íÊúâ‰ªª‰ΩïÁè≠Ê¨°Ë®òÈåÑ„ÄÇ";
        } else {
          Object.entries(stats)
            .sort((a, b) => b[1] - a[1]) // ÊåâÁè≠Ê¨°Êï∏ÈáèÊéíÂ∫è
            .forEach(([email, count]) => {
              const name = email.split("@")[0];
              report += `${name}: ${count} Â§©\n`;
            });

          const totalDays = Object.values(stats).reduce(
            (sum, count) => sum + count,
            0
          );
          report += `\nÁ∏ΩÂÖ±: ${totalDays} Â§©`;
        }

        alert(report);
      };

      // Ê∏ÖÈô§ÊàëÈÄôÂÄãÊúàÁöÑÊâÄÊúâÁè≠Ê¨°
      window.clearMyMonthlyShifts = async function () {
        // Âè™ËÆÄ‰ΩøÁî®ËÄÖ‰∏çËÉΩ‰øÆÊîπÁè≠Ë°®
        if (userRole === "readonly") {
          alert("ÊÇ®ÊòØÂè™ËÆÄÊ¨äÈôêÔºåÁÑ°Ê≥ï‰øÆÊîπÁè≠Ë°®„ÄÇ");
          return;
        }

        const monthNames = [
          "‰∏ÄÊúà",
          "‰∫åÊúà",
          "‰∏âÊúà",
          "ÂõõÊúà",
          "‰∫îÊúà",
          "ÂÖ≠Êúà",
          "‰∏ÉÊúà",
          "ÂÖ´Êúà",
          "‰πùÊúà",
          "ÂçÅÊúà",
          "ÂçÅ‰∏ÄÊúà",
          "ÂçÅ‰∫åÊúà",
        ];
        const currentMonthName =
          currentDate.getFullYear() +
          "Âπ¥ " +
          monthNames[currentDate.getMonth()];

        if (confirm(`Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§ÊÇ®Âú® ${currentMonthName} ÁöÑÊâÄÊúâÁè≠Ê¨°ÂóéÔºü`)) {
          // Ë®àÁÆóÁï∂ÊúàÁöÑÊó•ÊúüÁØÑÂúç
          const year = currentDate.getFullYear();
          const month = currentDate.getMonth();
          const startOfMonth = new Date(year, month, 1);
          const endOfMonth = new Date(year, month + 1, 0);

          const startDateStr = startOfMonth.toISOString().split("T")[0];
          const endDateStr = endOfMonth.toISOString().split("T")[0];

          console.log(`Ê∏ÖÈô§ ${startDateStr} Âà∞ ${endDateStr} ÁöÑÁè≠Ê¨°`);

          // ÊâæÂá∫ÈÄôÂÄãÊúàÊàëÁöÑÊâÄÊúâÁè≠Ê¨°
          const myMonthlyShifts = shiftsData.filter(
            (shift) =>
              shift.userId === currentUser.uid &&
              shift.date >= startDateStr &&
              shift.date <= endDateStr
          );

          console.log("ÊâæÂà∞Áè≠Ê¨°Êï∏Èáè:", myMonthlyShifts.length);

          if (myMonthlyShifts.length === 0) {
            alert("ÊÇ®Âú®ÈÄôÂÄãÊúàÊ≤íÊúâÊéíÁè≠Ë®òÈåÑ„ÄÇ");
            return;
          }

          // ÈÄê‰∏ÄÂà™Èô§
          for (const shift of myMonthlyShifts) {
            try {
              await removeShift(shift.id);
              // Âä†ÂÖ•Â∞èÂª∂ÈÅ≤ÈÅøÂÖçË´ãÊ±ÇÈÅéÊñºÈ†ªÁπÅ
              await new Promise((resolve) => setTimeout(resolve, 100));
            } catch (error) {
              console.error("Âà™Èô§Áè≠Ê¨°Â§±Êïó:", shift.date, error);
            }
          }

          alert(`Â∑≤Ê∏ÖÈô§ ${myMonthlyShifts.length} ÂÄãÁè≠Ê¨°ÔºÅ`);
        }
      };

      // ÂàùÂßãÂåñ
      renderCalendar();
    </script>
  </body>
</html>